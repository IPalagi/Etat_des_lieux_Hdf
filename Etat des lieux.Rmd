---
title: "Evolution_pram_Hdf_secheresse"
output: html_document
date: "2023-05-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=TRUE, warning=FALSE, message=FALSE)
```

# Etat des lieux de l'évolution en Hauts-de-France des paramètres température, hydrométrie, qualité chimique, poissons et macro-invertébrés 

Etat des lieux global de l'évolution des paramètres environnementaux et de biodiversité sur l'ensemble des stations de la région, après avoir défini les périodes de sécheresses via les stations hydrométriques de références utilisées dans les BSH. 


```{r}
#Importation des packages necessaires

library(tidyverse) 
library(aspe) # package pour les données poisson 
library(hubeau) #package pour les données de débits 
library(ggpubr) # package pour la réalisation de certains graphiques 
library(openxlsx) #package pour importer/exporter des Excel 
library(hydroTSM) #package traitement/analyse de séries temporelles liées à l'hydrologie 
library(Rmisc) # pour le traitement de données, notamment les barres d'erreurs sur les graphiques 
library(runner) # pour le calcule de moyennes glissanes 
library(lubridate) #pour la manipulation de dates 
library(magrittr)
library(rcompanion) #pour le test stats de Scheirer Ray Hare
library(agricolae) # pour certains tests statisiques post hoc ou de vérification de validité de modèles 
library(lme4) # pour les modèles linéaires mixtes 

```

## Identification des périodes de sécheresse hydrologique dans les Hauts-de-France 

Cette partie a pour but d'identifier les année où des sécheresses hydrologiques ont eu lieu dans la région. Elle se base sur l'étude des débits de 33 stations hydrométriques utilisées dans les BSH (Bulletins de Situation Hydrologique). Ces stations sont : 

Bassin Artois-Picardie : 

E5505720	AUTHIE	Dompierre/Authie
E5406510	TERNOISE	Hesdin
E5400310	CANCHE	Brimeux
E5300210	LIANE	Wirwignes
E5205710	WIMEREUX	Wimille
E4905710	YSER	Bambecque
E4306010	HEM	Guémy
E4035710	AA	Wizernes
E3646210	CLARENCE	Robecq
E3518510	LAQUETTE	Witternesse
E3511220	LYS	Delettes
E3346020	MARQUE	Ennevelin
E2367410	COURANT COUTICHES	Flines Lez Raches
E1827020	HOGNEAU	Thivencelle
E1766010	RHONELLE	Aulnoy
E1727510	ECAILLON	Thiant
D0206010	SOLRE	Ferrière la Grande
D0137010	HELPE MINEURE	Etroeungt
E6498315	Maye	Arry
E6470910	Somme canalisée	Abbeville US
E6426010	Selle	Plachy-Buyon
E6406010	Avre	Moreuil


Bassin Seine-Normandie : 

H7053110	Ancienne Sambre	Le Nouvion en Thiérache
H7021010	Oise	Hirson
H7142010	Serre	Mortiers
H7302020	Ailette	Chavignon
H5522010	Ourcq	Chouy
H7401010	Oise	Sempigny
H7423711	Aronde	Clairoix US
H7513010	Automne	Saintines
H7602010	Brêche	Nogent-sur-Oise
H7742010	Thérain	Beauvais
H7813210	Launette	Ver-sur-Launette

Les stations utilisées dans les BSH non utilisées ici le sont car il manque trop de données de débits. 



Définition de la sécheresse hydrologique : lorsque les débits passent en dessous d'un seuil, qui pourra être compris par exemple entre le Q90 et le Q70 de la courbe de la fréquence au dépassement des débits (plusieurs seuils pourront être testés pour identifier le plus pertinent). 

### Chargement des chroniques de débits  

La période sélectionnée pour calculer le seuil de sécheresse est de 31 ans de 1992 à 2022 pour toutes les stations sauf celles de la Laurette et de la Maye, pour lesquelles la période est 1994-2022 (pas de données en 1992-1993). 

Les valeurs de débits sont en l/s. Il y a quelques trous dans la donnée journalière, mais très peu.  

Importation des données de débits pour les 37 stations (il n'est pas necessaire d'executer ce code si le fichier RData contenant les data.frame de débits est disponible. Voir ci-après pour le chargement de ce RData) :

```{r, echo=FALSE, eval=FALSE}

# L'Authie à Dompierre 

q_E550 <- get_hydrometrie_obs_elab(
  list(code_entite = "E5505720",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Ternoise à Hesdine 

q_E5406 <- get_hydrometrie_obs_elab(
  list(code_entite = "E5406510",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Canche à Brimeux

q_E54003 <- get_hydrometrie_obs_elab(
  list(code_entite = "E5400310",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Liane à Wirwigne 

q_E530 <- get_hydrometrie_obs_elab(
  list(code_entite = "E5300210",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# Le Wimereux à Wimille 

q_E520 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E5205710",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Yser à Bambecque 

q_E490 <- get_hydrometrie_obs_elab( 
  list(code_entite = "E4905710",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Hem à Guémy 

q_E430 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E4306010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Aa à Wizernes 

q_E403 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E4035710",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La CLarence à Robecq 

q_E364 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E3646210",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Laquette à Witternesse 

q_E35185 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E3518510",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Lys à Delettes 

q_E35112 <- get_hydrometrie_obs_elab(
  list(code_entite = "E3511220",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Marque à Ennevelin 

q_E334 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E3346020",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2021-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))  # problème -> changement de station pour la Marque? pas de données 2022

q_E334_bis <- get_hydrometrie_obs_elab(      
  list(code_entite = "E3346022",
       date_debut_obs_elab = "2022-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

q_E334<-rbind(q_E334, q_E334_bis) # mise à la suite des deux data frame de débits pour faire une chronique complète 1992-2022

#Le Courant Coutiches à Flines lez Raches 

q_E236 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E2367410",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Hogneau à Thivencelle

q_E182 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E1827020",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Rhonelle à Aulnoy 

q_E176 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E1766010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# L'Ecaillon à Thiant 

q_E172 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E1727510",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Solre à Ferrière la Grande 

q_D020 <- get_hydrometrie_obs_elab(      
  list(code_entite = "D0206010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Helpe Mineure à Etroeungt

q_D013 <- get_hydrometrie_obs_elab(
  list(code_entite = "D0137010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Maye à Arry 

q_E649 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E6498315",
       date_debut_obs_elab = "1994-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee)) # pas de données avant mi-1993

#La Somme à Abbeville 

q_E647 <- get_hydrometrie_obs_elab(
  list(code_entite = "E6470910",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Selle à Plachy-Buyon 

q_E642 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E6426010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#Le Avre à Moreuil 

q_E64060 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E6406010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Somme à Lamotte-Brebière

q_E64009 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E6400910",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# L'Ancre à Bonnay 

q_E638<- get_hydrometrie_obs_elab(      
  list(code_entite = "E6386070",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Somme à Ham 

q_E635 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E6351420",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# Ancienne Smabre, Le Nouvion en Thiérache 

q_H705<- get_hydrometrie_obs_elab(      
  list(code_entite = "H7053110",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Oise à Hirson 

q_H702 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7021010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Serre à Mortiers 

q_H714 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7142010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Ailette à Chavignon 

q_H730 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7302020",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# L'Aisne à Soissons 

q_H650 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H6501020",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Ourcq à Chouy 

q_H552 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H5522010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# L'Oise à Sempigny 

q_H740 <- get_hydrometrie_obs_elab(
  list(code_entite = "H7401010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Automne à Saintines  

q_H751 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7513010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Breche à Nogent sur Oise 

q_H760 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7602010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#Le Therain à Beauvais 

q_H774<- get_hydrometrie_obs_elab(      
  list(code_entite = "H7742010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee)) 

# La Launette à Vers-sur-Launette 

q_H781 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7813210",
       date_debut_obs_elab = "1994-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee)) # pas de données avant mi-1993

#L'Aronde à Clairoix  

q_H742 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7423710",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmJ")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

```

Les stations de l'Aisne à Soisson, de la sommes à Lamotte-Brebière, de la Somme à Ham, de l'Ancre à Bonnay  n'ont pas assez de données sur la période 1992-2022 et ne seront donc pas utilisées.

Remarque : pour la station de l'Aronde (H742), il semblerait que l'API donne des valeurs pas complétement corrigées, car il y a des valeurs abhérentes (débit négatif ou nul brutalement sur 9 jours en plein hiver), dont une valeur nulle abhérente corrigée sur la banque Hydro. Les lignes abhérentes seront supprimées en filtrant les valeurs inférieures à 1 l/s (les valeurs abhrérentes sont les seules valeurs inférieurs à 1 sur toute la chronique). 

Pour E334, pas de données pour 2022, autre code station E3346022 qui donne les données manquantes. 

```{r, eval=FALSE}
# Suppression des lignes abhérentes remarquées pour la station H742 : 

q_H742<-q_H742 %>% 
  filter(resultat_obs_elab>1)
  
```


```{r, eval=FALSE}
# Téléchargement en RData des données de débits 

save(q_D013, q_D020, q_E172, q_E176, q_E182, q_E236, q_E334, q_E35112,q_E35185, 
     q_E364, q_E403, q_E430, q_E490, q_E520, q_E530, q_E54003, q_E5406, q_E550,
     q_E64060, q_E642, q_E647, q_E649, q_H552,
     q_H702, q_H705, q_H714, q_H730, q_H740, q_H742, q_H751, q_H760, q_H774, 
     q_H781, file="raw_data/q_journaliers_ref.RData")
```

Importation du fichier RData de débits si disponible : 

```{r}
load(file="raw_data/q_journaliers_ref.RData")
```

### Réalisation des courbes de fréquence au dépassement  

#### Seuil de sécheresse à q90

```{r}
# 
```

#### Seuil de sécheresse à q95

Les courbes de fréquences au dépassement (exemple ci-dessous pour la station E550) représentent les débits de l'année pour la période 1992-2022 classés par ordre décroissants en fonction de leur fréquence au dépassement : par exemple, le seuil de 0.95 de fréquence au dépassement est choisi comme seuil de sécheresse, ce qui veut dire que le débit seuil de sécheresse est celui qui est dépassé 95% du temps dans l'année. 

```{r}

fdc(q_E550$resultat_obs_elab, lQ.thr=0.95,hQ.thr=NA, 
              main="L'Authie à Dompierre",xlab="Fréquence au dépassement", ylab="Débit (l/s)") # Remplacer le nom du data frame de débits (par exemple q_E550) par celui de la station à étudier et le nom de la station dans main= 


```


### Identification des années de sécheresse pour un seuil à Q90 


### Identification des années de sécheresse pour un seuil à Q95
#### Nombre de jours en dessous du seuil de sécheresse 
##### Calcule du nombre de jours de sécheresse 

```{r, eval=FALSE }

# L'Authie 

sech_95_E550<-q_E550 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<4551))

# La Ternoise 

sech_95_E5406<-q_E5406 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<2890))

# La Canche 

sech_95_E54003<-q_E54003 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<7844)) 

# La Liane 

sech_95_E530<-q_E530 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<328)) 


# Le Wimereux 

sech_95_E520<-q_E520 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<64))

#L'Yser 

sech_95_E490<-q_E490 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<62))

#La Hem 

sech_95_E430<-q_E430 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<294))

#L'Aa 

sech_95_E403<-q_E403 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<2130))

#La Clarence 

sech_95_E364<-q_E364 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<284))

#La Laquette 

sech_95_E35185<-q_E35185 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<104))

# La Lys 

sech_95_E35112<-q_E35112 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<846))

# La Marque 

sech_95_E334<-q_E334 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<33))


# Le COurant Coutiches 

sech_95_E236<-q_E236 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<17))

# L'Hogneau 

sech_95_E182<-q_E182 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<317))

# La Rhonelle 

sech_95_E176<-q_E176 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<238))

#L'Ecaillon 

sech_95_E172<-q_E172 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<481))

#La Solre 

sech_95_D020<-q_D020 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<273))

#L'Helpe 

sech_95_D013<-q_D013 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<213))

# La Maye 

sech_95_E649<-q_E649 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<387))

annee<-c('1992', '1993')
duree_sech<-c(NA, NA)

complement_mq<-data.frame(annee, duree_sech)

sech_95_E649<-rbind(complement_mq, sech_95_E649)

# La somme à Abbeville 

sech_95_E647<-q_E647 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<19644))

# LA Selle 

sech_95_E642<-q_E642 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<2728))

# L'Avre 

sech_95_E64060<-q_E64060 %>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<913))

# L'Ancienne Sambre 

sech_95_H705<-q_H705%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<40))

#L'Oise à Hirson

sech_95_H702<-q_H702%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<231))

# La Serre 

sech_95_H714<-q_H714%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<2200))

#L'Ailette 

sech_95_H730<-q_H730%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<77))

#L'Ourcq 

sech_95_H552<-q_H552%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<761))

# L'Oise à Sempigny 

sech_95_H740<-q_H740%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<8120))

#L'Aronde 

sech_95_H742<-q_H742%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<371))

# L'Automne 

sech_95_H751<-q_H751%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<1099))

#La Brêche 

sech_95_H760<-q_H760%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<1217))

# Le Thérain 

sech_95_H774<-q_H774%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<2968))

#La Laurette 

sech_95_H781<-q_H781%>% 
  group_by(annee) %>% 
  summarise(duree_sech=sum(resultat_obs_elab<33))

complement_mq<-data.frame(annee, duree_sech) # création d'un data frame qui rassemble les deux vecteurs ci-dessus

sech_95_H781<-rbind(complement_mq, sech_95_H781) # Assemblage du data.frame de NA pour 1992 et 1993 et du data frame de durée de sécheresse entre 1994 et 2022 (il faut que le data.frame final ait 31 lignes pour pouvoir être assemblé avec les autres data frame de durée se sécheresse)


```


```{r, eval=FALSE}
# Assemblage des durées de sécheresse en un seul data frame (version tableau de contingence)

duree_sech_cont<-data.frame(annee=sech_95_D013$annee, D013=sech_95_D013$duree_sech,
                       D020=sech_95_D020$duree_sech,
                       E172=sech_95_E172$duree_sech,
                       E176=sech_95_E176$duree_sech,
                       E182=sech_95_E182$duree_sech,
                       E236=sech_95_E236$duree_sech,
                       E334=sech_95_E334$duree_sech,
                       E35112=sech_95_E35112$duree_sech,
                       E35185=sech_95_E35185$duree_sech,
                       E364=sech_95_E364$duree_sech,
                       E403=sech_95_E403$duree_sech,
                       E430=sech_95_E430$duree_sech,
                       E490=sech_95_E490$duree_sech,
                       E520=sech_95_E520$duree_sech,
                       E530=sech_95_E530$duree_sech,
                       E54003=sech_95_E54003$duree_sech,
                       E5406=sech_95_E5406$duree_sech,
                       E550=sech_95_E550$duree_sech,
                       E64060=sech_95_E64060$duree_sech,
                       E642=sech_95_E642$duree_sech,
                       E647=sech_95_E647$duree_sech,
                       E649=sech_95_E649$duree_sech,
                       H552=sech_95_H552$duree_sech,
                       H702=sech_95_H702$duree_sech,
                       H705=sech_95_H705$duree_sech,
                       H714=sech_95_H714$duree_sech,
                       H730=sech_95_H730$duree_sech,
                       H740=sech_95_H740$duree_sech,
                       H742=sech_95_H742$duree_sech,
                       H751=sech_95_H751$duree_sech,
                       H760=sech_95_H760$duree_sech,
                       H774=sech_95_H774$duree_sech,
                       H781=sech_95_H781$duree_sech)

#assemblage en data frame 

duree_sech<-rbind(sech_95_D013,
                       sech_95_D020,
                       sech_95_E172,
                       sech_95_E176,
                       sech_95_E182,
                       sech_95_E236,
                       sech_95_E334,
                       sech_95_E35112,
                       sech_95_E35185,
                       sech_95_E364,
                       sech_95_E403,
                       sech_95_E430,
                       sech_95_E490,
                       sech_95_E520,
                       sech_95_E530,
                       sech_95_E54003,
                       sech_95_E5406,
                       sech_95_E550,
                       sech_95_E64060,
                       sech_95_E642,
                       sech_95_E647,
                       sech_95_E649,
                       sech_95_H552,
                       sech_95_H702,
                       sech_95_H705,
                       sech_95_H714,
                       sech_95_H730,
                       sech_95_H740,
                       sech_95_H742,
                       sech_95_H751,
                       sech_95_H760,
                       sech_95_H774,
                       sech_95_H781)


```

Téléchargement en RData du data frame de durée de sécheresse : 

```{r, eval=FALSE}
save(duree_sech_cont, file="raw_data/duree_sech_cont.RData")
save(duree_sech, file="raw_data/duree_sech.RData")

```

```{r}
load(file="processed_data/duree_sech.RData")
load(file="processed_data/duree_sech_cont.RData")
```

##### Représentation visuelle de la durée de la sécheresse en jours 

La durée de la sécheresse est définie comme le nombre de jours par an en dessous du seuil de sécheresse (définit comme étant le q95 de la courbe de fréquence au dépassement). 

```{r}
# Boxplots durée de la sécheresse en jours en fonction des années 

duree_sech %>% 
   ggplot(aes(x=annee, y=duree_sech))+
  geom_boxplot(outlier.shape=NA)+
  theme(axis.text.x = element_text(angle = 90))

```
IL est possible de constater 4 grandes périodes sur lesquelles ont observe des tendances de sécheresses dans les Hauts-de-France :
-dans les années 1996-1997
-dans les années 2003 à 2006 
-en 2011 
-entre 2017 et 2022 (2021 expecté)

Ces périodes correspodent relativement bien au ressenti de l'établissement sur les périodes de sécheresse (réseau ONDE, observations de terrain lors des pêches electriques par exemple etc.), en particulier l'année 2022 qui ressort globalement comme ayant été soumise à une longue sécheresse hydrologique sur le graphique ci-dessus. Toutefois, on peut noter une grande variabilité de la durée des sécheresses selon les stations, avec des distributions très étendues.



```{r}
#nombre de stations en situation de sécheresse par an 

duree_sech_sum<-duree_sech%>% 
  dplyr::group_by(annee) %>% # groupement par année
  dplyr::summarise(nb_stations_sech=sum(duree_sech>0)) # calcule par année du nombre de station pour lequel la durée de sécheresse est non nulle 

```

```{r}
# histogramme du nombre de station en situation de sécheresse 

duree_sech_sum %>% 
  filter(annee %in% c(1994:2022)) %>% 
  ggplot(aes(x=annee, y=nb_stations_sech))+geom_col()+
  theme(axis.text.x = element_text(angle = 90))
  
```
On constate qu'il y a toujours des stations en situation de sécheresse quelque soit l'année, ce qui mets en évidence la grande variabilité de situation selon les stations. Toutefois, pour les années identifiées comme étant des années de sécheresse à l'échelle des Hauts-de-France (cf. boxplot ci-dessus), le nombre de stations en situation de sécheresse est élevé : pour l'année 2022 en particulier, 30 stations sur les 33 ont présenté une période de sécheresse, ce qui correspond au maximum sur la période 1994-2022. 

#### Hydraulicité mensuelle 

Calcule de l'hydraulicité mensuelle sur la période 1992-2022. L'hydraulicité est ici le rapport du débits moyen mensuel d'une année donnée sur le débits moyen mensuel inter annuel. Il donne une idée de l'écart à la normale. 

##### Chargement des débits moyens mensuels 

Les débits moyens mensuels utilisés sont ceux disponibles sur l'Hydro Portail (via l'API Hub'eau).  

```{r, echo=FALSE,eval=FALSE}
# L'Authie à Dompierre 

qm_E550 <- get_hydrometrie_obs_elab(
  list(code_entite = "E5505720",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Ternoise à Hesdine 

qm_E5406 <- get_hydrometrie_obs_elab(
  list(code_entite = "E5406510",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Canche à Brimeux

qm_E54003 <- get_hydrometrie_obs_elab(
  list(code_entite = "E5400310",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Liane à Wirwigne 

qm_E530 <- get_hydrometrie_obs_elab(
  list(code_entite = "E5300210",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# Le Wimereux à Wimille 

qm_E520 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E5205710",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Yser à Bambecque 

qm_E490 <- get_hydrometrie_obs_elab( 
  list(code_entite = "E4905710",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Hem à Guémy 

qm_E430 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E4306010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Aa à Wizernes 

qm_E403 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E4035710",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La CLarence à Robecq 

qm_E364 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E3646210",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Laquette à Witternesse 

qm_E35185 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E3518510",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Lys à Delettes 

qm_E35112 <- get_hydrometrie_obs_elab(
  list(code_entite = "E3511220",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Marque à Ennevelin 

qm_E334 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E3346020",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2021-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))  # pas toutes les données de La Marque à Ennevelin pour ce code station 

qm_E334_bis <- get_hydrometrie_obs_elab(      # code station avec les données manquantes de La Marque à Ennevelin
  list(code_entite = "E3346022",
       date_debut_obs_elab = "2022-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

qm_E334<-rbind(qm_E334, qm_E334_bis) # mise à la suite des deux data frame de débits pour faire une chronique complète 1992-2022

#Le Courant Coutiches à Flines lez Raches 

qm_E236 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E2367410",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Hogneau à Thivencelle

qm_E182 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E1827020",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Rhonelle à Aulnoy 

qm_E176 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E1766010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# L'Ecaillon à Thiant 

qm_E172 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E1727510",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Solre à Ferrière la Grande 

qm_D020 <- get_hydrometrie_obs_elab(      
  list(code_entite = "D0206010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Helpe Mineure à Etroeungt

qm_D013 <- get_hydrometrie_obs_elab(
  list(code_entite = "D0137010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Maye à Arry 

qm_E649 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E6498315",
       date_debut_obs_elab = "1994-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee)) # pas de données avant mi-1993

#La Somme à Abbeville 

qm_E647 <- get_hydrometrie_obs_elab(
  list(code_entite = "E6470910",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# La Selle à Plachy-Buyon 

qm_E642 <- get_hydrometrie_obs_elab(      
  list(code_entite = "E6426010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#Le Avre à Moreuil 

qm_E64060 <- get_hydrometrie_obs_elab(     
  list(code_entite = "E6406010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))


# Ancienne Smabre, Le Nouvion en Thiérache 

qm_H705<- get_hydrometrie_obs_elab(      
  list(code_entite = "H7053110",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Oise à Hirson 

qm_H702 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7021010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Serre à Mortiers 

qm_H714 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7142010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Ailette à Chavignon 

qm_H730 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7302020",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))


#L'Ourcq à Chouy 

qm_H552 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H5522010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

# L'Oise à Sempigny 

qm_H740 <- get_hydrometrie_obs_elab(
  list(code_entite = "H7401010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#L'Automne à Saintines  

qm_H751 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7513010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#La Breche à Nogent sur Oise 

qm_H760 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7602010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))

#Le Therain à Beauvais 

qm_H774<- get_hydrometrie_obs_elab(      
  list(code_entite = "H7742010",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee)) 

# La Launette à Vers-sur-Launette 

qm_H781 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7813210",
       date_debut_obs_elab = "1994-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee)) # pas de données avant mi-1993

#L'Aronde à Clairoix  

qm_H742 <- get_hydrometrie_obs_elab(      
  list(code_entite = "H7423710",
       date_debut_obs_elab = "1992-01-01",
       date_fin_obs_elab="2022-12-31",
       grandeur_hydro_elab = "QmM")) %>% 
  select(code_station:resultat_obs_elab) %>% 
  mutate(annee = lubridate::ymd(date_obs_elab),
         annee = lubridate::year(annee))
```

Téléchargement en RData des données de débits mensuels : 

```{r, eval=FALSE}
save(qm_D013, qm_D020, qm_E172, qm_E176, qm_E182, qm_E236, qm_E334, qm_E35112,qm_E35185, 
     qm_E364, qm_E403, qm_E430, qm_E490, qm_E520, qm_E530, qm_E54003, qm_E5406, qm_E550,
     qm_E64060, qm_E642, qm_E647, qm_E649, qm_H552,
     qm_H702, qm_H705, qm_H714, qm_H730, qm_H740, qm_H742, qm_H751, qm_H760, qm_H774, 
     qm_H781, file="raw_data/q_mensuels_ref.RData")
```

```{r}
load(file="raw_data/q_mensuels_ref.RData")
```

##### Calcul des débits moyens mensuels interannuels 

Chaque data frame qm_ia_x contient pour chaque mois de l'année le débits moyen mensuel inter annuel (Qm_ia) calculé sur la période 1992-2022 (ou 1994-2022 pour les stations sans données en 1992-1993) pour la station x. Ces débits seront considérés comme la référence mensuelle pour le calcul de l'hydraulicité.  

Pour le calcul des débits mensuels de référence (code ci-dessous), remplacer le code station par le code de la station pour laquelle on veur faire le calcul. 

```{r}

qm_ia_D013 <- qm_D013 %>%
  mutate(month = as.integer(substr(date_obs_elab, 6, 7))) %>% # création d'une colonne contenant uniquement  le mois
  dplyr::group_by(month) %>%
  dplyr::summarise(Qm_ia = mean(resultat_obs_elab)) # calcul des moyennes des débits mensuels regroupées par mois sur la période 1992-2022

qm_D013 <- qm_D013 %>%
  mutate(month = as.integer(substr(date_obs_elab, 6, 7))) # création d'une colonne mois

qm_D013 <-
  merge(qm_ia_D013, qm_D013, by = "month") # jointure des data frame de débits et de débits de référence par la modalité de mois 

 
```

(relancer la commande de sauvegarde des qm_x : maintenant, la colonne du débit mensuel inter annuel est comprise dans les data frame dès l'importation)

##### Calcul de l'hydraulicité (H) 


```{r, eval=FALSE}

H_D013<-qm_D013 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% # creation d'une colonne H qui divise la colonne de débits mensuel par celle de débits de référence 
  select(code_station, date_obs_elab, H) # selection des colonnes de code, date et hydraulicité

H_D020<-qm_D020 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E172<-qm_E172%>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E176<-qm_E176 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E182<-qm_E182 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E236<-qm_E236 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E236<-qm_E236 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E334<-qm_E334 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E35112<-qm_E35112 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E35185<-qm_E35185 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E364<-qm_E364 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E403<-qm_E403 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E430<-qm_E430 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E490<-qm_E490 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E520<-qm_E520 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E530<-qm_E530 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E54003<-qm_E54003 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E5406<-qm_E5406 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E550<-qm_E550 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E64060<-qm_E64060 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E642<-qm_E642 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E647<-qm_E647 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_E649<-qm_E649 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H552<-qm_H552 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H702<-qm_H702 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H705<-qm_H705 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H714<-qm_H714 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H730<-qm_H730 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H740<-qm_H740 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H742<-qm_H742 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H751<-qm_H751 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H760<-qm_H760 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H774<-qm_H774 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)

H_H781<-qm_H781 %>% 
  mutate(H=resultat_obs_elab/Qm_ia) %>% 
  select(code_station, date_obs_elab, H)


```



```{r, eval=FALSE}
# Création d'un seul data frame contenant les hydraulicités par station et par année 

hydraulicity<-rbind(H_D013, H_D020, H_E172, H_E176, H_E182, H_E236, H_E334, H_E35112,H_E35185, 
     H_E364, H_E403, H_E430, H_E490, H_E520, H_E530, H_E54003, H_E5406, H_E550,
     H_E64060, H_E642, H_E647, H_E649, H_H552,
     H_H702, H_H705, H_H714, H_H730, H_H740, H_H742, H_H751, H_H760, H_H774, 
     H_H781) 

#création d'une colonne de mois et d'année (de nouveau, parce que j'ai fait la bêtise de les enlever à la création des H_x)

hydraulicity<-hydraulicity %>% 
  mutate(month = as.integer(substr(date_obs_elab, 6, 7))) %>% 
  mutate(annee = as.integer(substr(date_obs_elab, 1, 4))) 

hydraulicity$annee<-as.factor(hydraulicity$annee) #conversion colonne annee de entier à facteur
hydraulicity$month<-as.factor(hydraulicity$month) # conversion colonne month de entier à facteur


```

```{r, eval=FALSE}
# Sauvegarde du data frame d'hydraulicité 

save(hydraulicity, file="processed_data/hydraulicity.RData")

```

```{r}
# Importation du RData hydraulicity si il n'est pas déjà dans l'environnement 

load(file="processed_data/hydraulicity.RData")
```

##### Représentation graphique de l'hydraulicité 


```{r}
hydraulicity %>% 
  dplyr::group_by(date_obs_elab) %>% 
dplyr::summarise(med_H=median(H)) %>% 
            ggplot(
  aes(x = date_obs_elab, y = med_H)
) +
geom_line()+
  theme(axis.text.x = element_text(angle = 90))+
  geom_line(aes(x=date_obs_elab, y=1), col="red")+
  scale_x_date(date_breaks = "1 year")
```
Le graphique ci-dessus représente l'hydraulicité mensuelle médiane sur les 33 stations (31 pour 1992 et 1993) en fonction du temps. La droite y=1 correspond à la situation où le débit moyen mensuel est égal au débit moyen mensuel inter annuel. Lorsque la courbe de l'hydraulicité est au dessus de cette droite, les débits moyens mensuels sont plus élevés que lors d'une année que l'on peut considérer comme "normale". Au contraire, lorsque la courbe passe en dessous de la droite, les débits sont plus faibles que la normale. 

L'évolution de l'hydraulicité sur la période 1992-2022 mets en évidence les mêmes périodes de déficit en eau que la représentation de la durée de sécheresse. 

```{r}
hydraulicity %>% 
  filter(annee %in% c("2022", "2020", "2019", "2018","2017", "2011")) %>% 
   dplyr::group_by(month, annee) %>% 
dplyr::summarise(med_H=median(H)) %>% 
  ggplot(aes(x=month, y=med_H, fill=annee))+
  geom_col(position='dodge', stat="identity")+
  scale_fill_brewer(palette="Set1")
  
```

```{r}
hydraulicity %>% 
  filter(annee %in% c("2022", "2020", "2019", "2018","2017","2011")) %>% 
   dplyr::group_by(month, annee) %>% 
dplyr::summarise(med_H=median(H)) %>% 
  ggplot(aes(x=month, y=med_H, fill=annee))+
  geom_col(position='stack', stat="identity")+
  scale_fill_brewer(palette="Set1")
```

##### Calcul des VCN10

Les VCN10 seront calculés à partir des débits spécifiques de chaque station (débits réels divisées par la surface du bassin versant amont), afin de pouvoir comparer ces VCN10 et les agréger à l'échelle régionale. 

```{r, eval=FALSE}
# Calcul des débits spécifiques 

q_E550<-q_E550 %>% 
  mutate(Q_spe=resultat_obs_elab/796)

q_E5406<-q_E5406 %>% 
  mutate(Q_spe=resultat_obs_elab/345)

q_E54003<-q_E54003 %>% 
  mutate(Q_spe=resultat_obs_elab/918)

q_E530<-q_E530 %>% 
  mutate(Q_spe=resultat_obs_elab/100)

q_E520<-q_E520 %>% 
  mutate(Q_spe=resultat_obs_elab/74)

q_E490<-q_E490 %>% 
  mutate(Q_spe=resultat_obs_elab/239)

q_E430<-q_E430 %>% 
  mutate(Q_spe=resultat_obs_elab/105)

q_E403<-q_E403 %>% 
  mutate(Q_spe=resultat_obs_elab/392)

q_E364<-q_E364 %>% 
  dplyr::mutate(Q_spe=resultat_obs_elab/156)

q_E35185<-q_E35185 %>% 
  mutate(Q_spe=resultat_obs_elab/80)

q_E35112<-q_E35112 %>% 
  mutate(Q_spe=resultat_obs_elab/161)

q_E236<-q_E236 %>% 
  mutate(Q_spe=resultat_obs_elab/52)

q_E182<-q_E182 %>% 
  mutate(Q_spe=resultat_obs_elab/240)

q_E176<-q_E176 %>% 
  mutate(Q_spe=resultat_obs_elab/88.4)

q_E172<-q_E172 %>% 
  mutate(Q_spe=resultat_obs_elab/173)

q_D020<-q_D020 %>% 
  mutate(Q_spe=resultat_obs_elab/115)

q_D013<-q_D013 %>% 
  mutate(Q_spe=resultat_obs_elab/156)

q_E649<-q_E649%>% 
  mutate(Q_spe=resultat_obs_elab/96)

q_E647<-q_E647 %>% 
  mutate(Q_spe=resultat_obs_elab/5640)

q_E642<-q_E642 %>% 
  mutate(Q_spe=resultat_obs_elab/540)

q_E64060<-q_E64060 %>% 
  mutate(Q_spe=resultat_obs_elab/624)

q_H705<-q_H705 %>% 
  mutate(Q_spe=resultat_obs_elab/21)

q_H702<-q_H702 %>% 
  mutate(Q_spe=resultat_obs_elab/314)

q_H714<-q_H714 %>% 
  mutate(Q_spe=resultat_obs_elab/748)

q_H730<-q_H730 %>% 
  mutate(Q_spe=resultat_obs_elab/119)

q_H552<-q_H552 %>% 
  mutate(Q_spe=resultat_obs_elab/347)

q_H740<-q_H740 %>% 
  dplyr::mutate(Q_spe=resultat_obs_elab/4316)

q_H742<-q_H742 %>% 
  mutate(Q_spe=resultat_obs_elab/282)

q_H751<-q_H751 %>% 
  mutate(Q_spe=resultat_obs_elab/276)

q_H760<-q_H760 %>% 
  mutate(Q_spe=resultat_obs_elab/457)

q_H774<-q_H774 %>% 
  mutate(Q_spe=resultat_obs_elab/750)

q_H781<-q_H781 %>% 
  mutate(Q_spe=resultat_obs_elab/42)

q_E334<-q_E334 %>% 
  mutate(Q_spe=resultat_obs_elab/8,6)

```


Le calcule du VCN10 se fait en utilisant la fonction mean_run qui permet de calculer une moyenne glissante. 
Changer le code de la station avec Ctrl+F pour calculer le VCN10 pour une autre station. 

```{r, eval=FALSE}

q_H760$date_obs_elab<-as.Date(q_H760$date_obs_elab) #conversion colonne date du data frame de débits journaliers en format date
dates<-q_H760$date_obs_elab #création d'un vecteur de dates

dates<-sort(dates, decreasing = FALSE)

VCN10_H760<-
  mean_run(q_H760$Q_spe,   # calcul d'une moyenne glissante des débits spécifiques sur k=10 jours 
                       k = 10, 
                       idx = dates
                       )

VCN10_H760<-data.frame(VCN10_H760, dates, annee=substr(dates, 1,4)) # création d'un data frame avec les moyennes glissantes, les dates et les années 

VCN10_H760<-VCN10_H760 %>% 
  dplyr::group_by(annee) %>% 
  dplyr::summarise(VCN10_annuel=min(VCN10_H760)) # calcule du minimum par années des moyennes glissantes -> VCN10 annuel 


```

```{r, eval=FALSE}
save(VCN10_D013, VCN10_D020, VCN10_E172, VCN10_E176, VCN10_E182, VCN10_E236, VCN10_E334, VCN10_E35112,VCN10_E35185, 
     VCN10_E364, VCN10_E403, VCN10_E430, VCN10_E490, VCN10_E520, VCN10_E530, VCN10_E54003, VCN10_E5406, VCN10_E550,
     VCN10_E64060, VCN10_E642, VCN10_E647, VCN10_E649, VCN10_H552,
     VCN10_H702, VCN10_H705, VCN10_H714, VCN10_H730, VCN10_H740, VCN10_H742, VCN10_H751, VCN10_H760, VCN10_H774, 
     VCN10_H781, file="processed_data/VCN10_annuels.RData")
```

```{r}
load(file="processed_data/VCN10_annuels.RData")
```

Maintenant que l'on dispose de tous les VCN10 annuels par station, on peut les assembler au sein d'un même data frame pour pouvoir tracer les graphiques par la suite. 

```{r}
#assemblage en un seul data frame 

VCN10<-rbind(VCN10_D013, VCN10_D020, VCN10_E172, VCN10_E176, VCN10_E182, VCN10_E236, VCN10_E334, VCN10_E35112,VCN10_E35185, 
     VCN10_E364, VCN10_E403, VCN10_E430, VCN10_E490, VCN10_E520, VCN10_E530, VCN10_E54003, VCN10_E5406, VCN10_E550,
     VCN10_E64060, VCN10_E642, VCN10_E647, VCN10_E649, VCN10_H552,
     VCN10_H702, VCN10_H705, VCN10_H714, VCN10_H730, VCN10_H740, VCN10_H742, VCN10_H751, VCN10_H760, VCN10_H774, 
     VCN10_H781) 

```


##### Représentation graphique des VCN10 

```{r}
VCN10 %>% 
   ggplot(aes(x=annee, y=VCN10_annuel))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
VCN10 %>% 
  dplyr::group_by(annee) %>% 
  dplyr::summarise(med_VCN10=median(VCN10_annuel)) %>% 
   ggplot(aes(x=annee, y=med_VCN10))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90))
```

## Evolution de la température 

Les températures utilisées sont issues des mesures rélles de 33 stations du reseau RNT de l'OFB Hauts-de-France, complétées par les températures modélisées lors du projer TIGRE lorsque la température réelle n'est pas disponible. Cette analyse se fera sur la période 2008-2018, le projet TIGRE n'ayant pas modélisé les températures après 2018. Les données TIGRE sont au pas de temps journalier et reprennent sur la période 2008-2018 les températures réelles au pas de temps journalier (pas de temps horaire pour les données OFB versées dans le RNT).   

### Création des data.frame de température

#### Importation des fichiers de données du projet TIGRE 

Les données de température de Hauts-de-France du projet TIGRE ont été fournies sous format csv par Eddy Cosson de la Direction Surveillance, Evaluation, Données, Service Eaux et Milieux Aquatiques de l'OFB. Un colonne de numéro de station a été rajoutée aux csv avant importation dans R. 

```{r, eval=FALSE}
# Importation des csv de température 

t_1001336<-read.csv(file="raw_data/TIGRE_temp_Hdf/1001336.csv", sep=";")

t_1004000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1004000.csv", sep=";")

t_1006000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1006000.csv", sep=";")

t_1009000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1009000.csv", sep=";")

t_1010000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1010000.csv", sep=";")

t_1029000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1029000.csv", sep=";")

t_1037000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1037000.csv", sep=";")

t_1045000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1045000.csv", sep=";")

t_1056000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1056000.csv", sep=";")

t_1071000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1071000.csv", sep=";")

t_1090000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1090000.csv", sep=";")

t_1100000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1100000.csv", sep=";")

t_1101000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1101000.csv", sep=";")

t_1115000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1115000.csv", sep=";")

t_1116000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1116000.csv", sep=";")

t_1129000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1129000.csv", sep=";")

t_1133000<-read.csv(file="raw_data/TIGRE_temp_Hdf/1133000.csv", sep=";")

t_1134500<-read.csv(file="raw_data/TIGRE_temp_Hdf/1134500.csv", sep=";")

t_1138300<-read.csv(file="raw_data/TIGRE_temp_Hdf/1138300.csv", sep=";")

t_1140500<-read.csv(file="raw_data/TIGRE_temp_Hdf/1140500.csv", sep=";")

t_1141100<-read.csv(file="raw_data/TIGRE_temp_Hdf/1141100.csv", sep=";")

t_3128190<-read.csv(file="raw_data/TIGRE_temp_Hdf/3128190.csv", sep=";")

t_3128270<-read.csv(file="raw_data/TIGRE_temp_Hdf/3128270.csv", sep=";")

t_3129020<-read.csv(file="raw_data/TIGRE_temp_Hdf/3129020.csv", sep=";")

t_3134730<-read.csv(file="raw_data/TIGRE_temp_Hdf/3134730.csv", sep=";")

t_3136000<-read.csv(file="raw_data/TIGRE_temp_Hdf/3136000.csv", sep=";")

t_3138390<-read.csv(file="raw_data/TIGRE_temp_Hdf/3138390.csv", sep=";")

t_3142520<-read.csv(file="raw_data/TIGRE_temp_Hdf/3142520.csv", sep=";")

t_3144475<-read.csv(file="raw_data/TIGRE_temp_Hdf/3144475.csv", sep=";")

t_3152000<-read.csv(file="raw_data/TIGRE_temp_Hdf/3152000.csv", sep=";")

t_3156000<-read.csv(file="raw_data/TIGRE_temp_Hdf/3156000.csv", sep=";")

t_3162240<-read.csv(file="raw_data/TIGRE_temp_Hdf/3162240.csv", sep=";")

t_3164180<-read.csv(file="raw_data/TIGRE_temp_Hdf/3164180.csv", sep=";")

t_1001336<-read.csv(file="raw_data/TIGRE_temp_Hdf/1001336.csv", sep=";")


```

```{r, eval=FALSE}
# création d'un seul data frame avec les températures 
temperatures<-rbind(t_1001336,t_1004000,
t_1006000,
t_1009000,
t_1010000,
t_1029000,
t_1037000,
t_1045000,
t_1056000,
t_1071000,
t_1090000,
t_1100000,
t_1101000,
t_1115000,
t_1116000,
t_1129000,
t_1133000,
t_1134500,
t_1138300,
t_1140500,
t_1141100,
t_3128190,
t_3128270,
t_3129020,
t_3134730,
t_3136000,
t_3138390,
t_3142520,
t_3144475,
t_3152000,
t_3156000,
t_3162240,
t_3164180,
t_1001336
)
```


Explication des colonnes du data frame : 

Tw_raw : température de l'eau brutes réelles 
Tw_detect : température de l'eau réelles avec corection des valeurs abérentes
Ta : température de l'air 
Tw_corr : température de l'eau modélisée 


#### Mélange des données réelles et simulées 

L'idée de cette partie est de créer une colonne dans le data frame "temperatures" qui contienne les données réelles quand elle sont disponibles, sinon les données modélisées. Cette colonne sera nommée "Tw_fusion". Une autre colonne "statut" sera créee, pour indiquée si les valeurs de températures de "Tw_fusion" sont réelles ou modélisées. 


```{r, eval=FALSE}
for(i in 1:129370){ # on parcours ligne par ligne la data frame de temperature 
  
  if(is.na(temperatures$Tw_detect[i])){   # si pour la ligne i il n'y a pas de donnée réelle de température (NA): 
    temperatures$Tw_fusion[i] <- temperatures$Tw_corr[i] #la ligne i de Tw_fusion prends la valeur de la température modélisée 
    temperatures$statut[i]<-"modelise" # la ligne i de "statut" indique que la valeur de température est modélisée 
  }
  else{  # sinon : 
    temperatures$Tw_fusion[i] <- temperatures$Tw_detect[i] # la ligne i de la colonne Tw_fusion prends la valeur de la température réelle 
    temperatures$statut[i]<-"reel" # la ligne i de la colonne "statut" indique que la valeur de tempéraure est réelle
  }
}
```

On sauvegarde le data frame de températures (d'autant plus important dans ce cas car la boucle for pour créer les colonnesTw_fusion et statut mets un peu de temps à tourner. Voir s'il n'est pas possible d'optimiser la création des colonnes). 

```{r, eval=FALSE }
save(temperatures, file="raw_data/temperatures.RData")
```

```{r}
# Importation du data frame temperatures si pas déjà dans l'environnement 

load(file="raw_data/temperatures.RData")
```

```{r}

```

### Calcul d'indicateurs de température 

Les indicateurs de température chosis pour cette partie sont : 

-les températures moyenne et maximum annuelles 
-température maximale moyenne sur 7 jours consécutifs dans l'année 
-les anomalies des températures moyennes annuelles par rapport à la moyenne internannuelle sur la période 2008-2018

#### Calcul des températures moyennes et maximums annuelles 

```{r}
# Température moyenne 

temperatures<- temperatures%>%
  mutate(annee = as.factor(substr(Date, 7, 10))) %>%  # création d'une colonne année 
  mutate(month=as.factor(substr(Date, 4, 5))) # création colonne de mois 

mean_temp<-temperatures %>% 
  dplyr::group_by(code_station,annee) %>%  #groupement par station et par année des températures journalières 
  dplyr::summarise(T_moy=mean(Tw_fusion))  # calcul de la moyenne annuelle des températures 

#Température maximum 

max_temp<-temperatures %>% 
  dplyr::group_by(code_station,annee) %>%  #groupement par station et par année des températures journalières 
  dplyr::summarise(T_max=max(Tw_fusion))

#rassemblement dans le même data frame

temp_annee<-cbind(max_temp, mean_temp)

temp_annee<-temp_annee %>% 
  select(code_station=code_station...1, annee=annee...2, T_max, T_moy)

temp_annee$annee<-as.factor(temp_annee$annee)
temp_annee$code_station<-as.factor(temp_annee$code_station)
  
```

#### Calcul des température moyennes et maximales mensuelles 

```{r}
mean_temp_mois<-temperatures %>% 
  dplyr::group_by(month, annee) %>%   
  dplyr::summarise(T_moy_mois=mean(Tw_fusion)) 

mean_temp_mois$annee<-as.factor(mean_temp_mois$annee)

max_temp_mois<-temperatures %>% 
  dplyr::group_by(month,annee) %>%   
  dplyr::summarise(T_max_mois=max(Tw_fusion))

max_temp_mois$annee<-as.factor(max_temp_mois$annee)

```

Remarque : il est précisé dans le chunck ci-dessus que la fonction group_by doit provenir du package dplyr, car il y avait un problème d'interférence avec un autre package, probablement summarySE. Faire de même dans les autres chuncks si le résultat du group_by n'est pas celui attendu (une ligne unique par data frame). 


#### Calcul de la température maximale moyenne sur 7 jours consécutifs 

Le calcul de cet indicateur se fait sur le même modèle que le calcule du VCN10 pour les débits, c'est à dire qu'une moyenne glissante est calculée (ici sur 7 jours) sur toute la période considérée, et le minimum annuel de cette moyenne glissante donne la valeur de l'indicateur. 

La même fonction sera utilisée pour ce calcul que pour le calcul du VCN10. 

```{r}
temperatures$Date<-dmy(temperatures$Date) #conversion colonne date du data frame de températures en format date

dates<-temperatures$Date #création d'un vecteur de dates

dates<-sort(dates, decreasing = FALSE)

Tmax_7jr<-
  mean_run(temperatures$Tw_fusion,   # calcul d'une moyenne glissante des débits spécifiques sur k=10 jours 
                       k = 7, 
                       idx = dates
                       )

Tmax_7jr<-data.frame(Tmax_7jr, dates, annee=substr(dates, 1,4)) # création d'un data frame avec les moyennes glissantes, les dates et les années 

Tmax_7jr<-Tmax_7jr %>% 
  dplyr::group_by(annee) %>% 
  dplyr::summarise(Tmax_7jr_annuel=max(Tmax_7jr)) # calcule du minimum par années des moyennes glissantes 

```



### Représentation graphique de la température sur la période 2008-2018
#### Evolution des températures maximales et moyennes 

```{r}
temp_annee %>% 
  ggplot()+
  geom_boxplot(aes(x=annee, y=T_moy))+
  geom_point(aes(x=annee, y=T_moy, color=code_station))
  
```

```{r}
temp_annee %>% 
  ggplot()+
  geom_boxplot(aes(x=annee, y=T_max))+
  geom_point(aes(x=annee, y=T_max, color=code_station))
```

```{r}
temp_annee %>% 
  dplyr::group_by(annee) %>% 
  dplyr::summarise(T_max=median(T_max)) %>% 
  ggplot(aes(x=annee, y=T_max, group=1))+
  geom_point(stat="summary")+stat_summary(geom="line")
```



```{r}
# Histogramme T max annuelle 

test<-temp_annee %>% 
  summarySE(measurevar="T_max", groupvars = "annee") 

test %>% 
ggplot(aes(x = annee, y= T_max)) + 
  geom_col() + 
  geom_errorbar(aes(ymin=T_max-se, ymax=T_max+se),width=.2,  position=position_dodge(.9)) 
```

```{r}
# Histogramme T moy annuelle 

test<-temp_annee %>% 
  summarySE(measurevar="T_moy", groupvars = "annee") 

test %>% 
ggplot(aes(x = annee, y= T_moy)) + 
  geom_col() + 
  geom_errorbar(aes(ymin=T_moy-se, ymax=T_moy+se),width=.2,  position=position_dodge(.9))
  
```

```{r}
# histogrammes Tmoy mensuel par année 

 mean_temp_mois %>% 
  ggplot(aes(x=month, y=T_moy_mois, fill=annee))+
  geom_col(position='dodge', stat="identity")+
  scale_fill_brewer(palette="Paired")
```

Remarque : les données de températures commencent en Aout 2008, il n'y a donc pas de barre pour 2008 pour les mois 1 à 7

```{r}
#histogramme Tmax mensuelle par année 

max_temp_mois %>% 
  ggplot(aes(x=month, y=T_max_mois, fill=annee))+
  geom_col(position='dodge', stat="identity")+
  scale_fill_brewer(palette="Paired")
```


#### Evolution de températures max sur 7 jours consécutifs annuels 

```{r}
Tmax_7jr %>% 
  ggplot(aes(x=annee, y=Tmax_7jr_annuel))+
  geom_col()
```

## Evolution des paramètres "poisson"
### Chargement des données d'IPR, ses métriques et des mesures individuelles pour les Hdf

Les données piscioles pour la région Hdf ont déjà été extraites des bases de données dans un autre projet R et seront réutilisées. Les IPR et leurs métriques seront mis sous forme de graphiques uniquement pour mettre en évidence la difficulté de les agréger à une échelle départementale.

```{r}
# Chargement du tableau de données IPR et des tables du package aspe

load(file="raw_data/IPR.RData")
load(file="raw_data/tables_sauf_mei_2023_05_10_10_16_44.RData")
load(file="raw_data/mei_hdf.RData")

```

Remarque : Dans la data frame, la station de la sainte-marie est notée en RRP alors que c'est une RCS pour l'année 2018. 


```{r}

ipr<-ipr %>% 
  drop_na() %>% # suppression des NA 
  unique() 

ipr$annee<-as.factor(ipr$annee) #conversion de la variable année de numérique à facteur 
ipr$sta_id<-as.factor(ipr$sta_id)
  
```


### Identification des stations à utiliser 

Il s'agit ici d'identifier quelles stations de pêche prendre afin d'avoir un nombre constant de stations (les mêmes) sur une période suffisamment grande (idéalement au moins 2010-2022) pour pourvoir faire une comparaison inter annuelle qui ait du sens. 

On peut commencer par regarder le nombre de stations pêchées par an :  

```{r}
ipr %>% 
 ggplot(aes(x=annee))+geom_histogram(stat="count")+
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white")
```

Le nombre de station est très variable selon les années. Le premier élement est que beaucoup de station font partie du réseau RCS, dont les pêches se font tous les deux ans. Ont peut distinguer les stations dont les prélèvement se font les années paires, et celles dont ils se font les années impaires. De plus, certaines stations ont été ouvertes pendant la période 2002-2022, modifiant là aussi les stations pêchées pour une année. 

Une stratégie possible pour conserver les mêmes stations tous les ans est de ne conserver que les stations des réseaux RRP et RHP (pêchées chaque année) pêchées jusqu'en 2022, ou de ne garder que les stations des années paires (qui incluent donc une pêche en 2022, année de sécheresse la plus identifiable). 

```{r} 

# Ajout d'une colonne code_sandre à "ipr" pour plus facilement identifier les stations 

ipr<-merge(ipr, station, by="sta_id") %>% 
  select(sta_id, dept, obj_libelle, ipr, cli_libelle, ope_date:sta_code_sandre)
```

```{r} 

# Nombre de stations des réseaux RHP et RRP pêchées en 2022 

ipr %>% 
  filter(annee==2022 & obj_libelle %in% c("RHP – Réseau Hydrobiologique Piscicole", 
                            "RRP – Réseau de Référence Pérenne")) %>% 
  distinct(sta_id)
  
  
```

Il y a visiblement 16 stations répertoriées comme RHP ou RRP pêchées en 2022 (avec probablement des erreurs, comme pour la Sainte-Marie qui est répertoriée comme RRP pour une année). 

Il faut maintenant identifier les stations avec des données jusque 2022.

```{r}
# création d'une grande palette de couleur (22 couleurs) contrastée pour faciliter la lecture graphique 

palette<-c('#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080', '#ffffff', '#000000')
```


```{r}
# graphique en histogramme stack de l'ipr par station RRp ou RHP depuis 2002, qui permet de voir les stations ayant de la données par année

ipr %>% 
  filter(sta_id %in% c("123", "154", "203", "209", "262",
                       "4959", "278", "4830", "5307", "5503",
                       "5314", "5930", "5980", "6168", "6434",
                       "7")) %>%
  ggplot(aes(x=annee, y=ipr, fill=sta_id))+
  geom_col(position='stack', stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values=palette)
  
  
```

Les seules stations disposant de données tous les ans sur la période 2010-2022 sont les stations :

-7 (la slack à rinxent)
-5930 (l'aisne à condes sur aisne)
-5980 (l'aisne à choisy au bac)
-5503 (l'oise à ponte saint maxence)
-4830 (l'ourcq à ferre en tardenois)
-209 (l'aa à verchocque)


```{r}

# création de deux vecteurs de date pour ne pas avoir à tout taper à chaque fois

periode<-c("2010","2011","2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022")
periode2<-c("2010", "2012", "2014", "2016", "2018", "2020", "2022")
```

Stations RRp ou RHP ayant de la données tous les deux ans sur la période 2010-2022: 

```{r}
# graphique en histogramme stack de l'ipr par station en fonction de la période 2, qui permet de voir les stations ayant de la données par année 

ipr %>% 
  filter(sta_id %in% c("123", "154", "203", "209", "262",
                       "4959", "278", "4830", "5307", "5503",
                       "5314", "5930", "5980", "6168", "6434",
                       "7") & annee %in% periode2) %>%
  ggplot(aes(x=annee, y=ipr, fill=sta_id))+
  geom_col(position='stack', stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values=palette)
  
```
9 stations RHP et RRP disposent de données tous les deux ans depuis 2010. Ce sont les stations 7, 154, 209,262, 4830, 5307, 5503, 5930, 5980. 

#### Années paires 

On peut effectuer la même démarche que ci-dessus pour identifier les stations RCS des années paires ayant des données entre 2010 et 2022. 

```{r}

# Nombre de stations de pêches RCS avec des données en 2022

sta_id_RCS<-ipr %>%  #création d'un data frame de une colonne contenant les sta_id des stations RCS de 2022
  filter(annee==2022 & obj_libelle=="RCS – Réseau de Contrôle de Surveillance") %>% 
  distinct(sta_id) 

sta_id_RCS$sta_id<-as.character(sta_id_RCS$sta_id)
sta_id_RCS<-as.vector(sta_id_RCS$sta_id) # conversion du data frame en vecteur 

```

47 stations de RCS disposent de données en 2022. 

```{r}

nb_sta_RCS<-ipr %>% 
  filter( annee %in% periode2 & sta_id %in% sta_id_RCS & 
            obj_libelle=="RCS – Réseau de Contrôle de Surveillance") %>%
  dplyr::group_by(sta_id) %>% 
  dplyr::summarise(nb_annee=n()) 

sta_id_RCS<-nb_sta_RCS %>% 
  filter(nb_annee>=7)

sta_id_RCS<-as.vector(sta_id_RCS$sta_id)
  
```

Le code ci-dessous renvoie les nombre d'année avec des données sur les années paires de la période 2010-2022 (nb_sta_RCS). Idéalement, il faudrait que les stations ait un nombre d'année égal à 7 (un prélèvement sur les années paires entre 2010 et 2022). C'est pourquoi ne sont gardées que les stations dont le nombre d'années de nb_sta_RCS est suppérieur ou égal à 7. 

Il y a 16 stations qui à priori disposent de données tous les deux ans sur la période 2010-2022. 

Nous pouvons vérifier qu'elles ont effectivement assez de données en traçant le graphique suivant : 

```{r}

ipr %>% 
  filter(sta_id %in% sta_id_RCS & annee %in% periode2) %>%
  ggplot(aes(x=annee, y=ipr, fill=sta_id))+
  geom_col(position='stack', stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values=palette)  
  
```

Toutes les 16 stations filtrées ont effectivement de la données tous les deux ans depuis 2010. 4 des stations RCS filtrées sont aussi des stations RHP ayant de la donnée ces années-là (mêmes prélèvement mais nom de réseau différent). 

On se retrouve finalement avec 20 stations de pêches tous réseaux confondus qui permettent d'étudier les données piscicoles tous les deux ans de 2010 à 2022 et 6 stations (RHP et RRP) qui permettent d'étudier les données tous les deux ans de 2010 à 2022.   

```{r}
#création du vecteur des 20 stations avec données tous les deux ans entre 2010 et 2022 

sta_peche_paire<-c(sta_id_RCS,"209", "262", "4830", "5930")
```

On peut vérifier que ces stations ont le bon nombre de données, et voir si on ne peut pas étendre la période:

```{r}
ipr %>% 
  filter(sta_id %in% sta_peche_paire & annee %in% c("2002", "2004", "2006", "2008", "2010", "2012", "2014", "2016", "2018", "2020", "2022")) %>%
  ggplot(aes(x=annee, y=ipr, fill=sta_id))+
  geom_col(position='stack', stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values=palette)
```
On constate qu'en 2008 ces stations ont aussi de la donnée. On peut donc étendre la période au années paires entre 2008 et 2022, soit 8 années. 

#### Années impaires 

```{r}

periode3<-c( "2011", "2013", "2015", "2017", "2019", "2021")

nb_sta_RCS<-ipr %>% 
  filter( annee %in% periode3 & 
            obj_libelle=="RCS – Réseau de Contrôle de Surveillance") %>%
  dplyr::group_by(sta_id) %>% 
  dplyr::summarise(nb_annee=n()) 

sta_id_RCS<-nb_sta_RCS %>% 
  filter(nb_annee>=6)

sta_id_RCS<-as.vector(sta_id_RCS$sta_id)
```

Uniquement 7 stations RCS ont de la données tous les deux ans les années impaires entre 2010 et 2022. Ces stations sont 188, 267, 5253, 5443, 5690, 5930, 5953. 

```{r}
ipr %>% 
  filter(sta_id %in% c("123", "154", "203", "209", "262",
                       "4959", "278", "4830", "5307", "5503",
                       "5314", "5930", "5980", "6168", "6434",
                       "7") & annee %in% periode3) %>%
  ggplot(aes(x=annee, y=ipr, fill=sta_id))+
  geom_col(position='stack', stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values=palette)
  
```
7 stations RRP ou RHP ont de la données sur les années impaires entre 2010 et 2022. Ces stations sont 5980, 5930, 5503, 4830, 123, 209 et 7. 

En tout il y a donc 13 stations tous reseaux confondus ayant de la donnée les années impaires entre 2010 et 2022 (en supprimant les doublons entre reseaux.)

On peut essayer avec une autres méthode pour confirmer (cette fois-ci tous réseaux confondus): 

```{r}

sta_aspe_2011<-ipr %>% 
  filter(annee==2011) %>% 
  distinct(sta_id)

sta_aspe_2013<-ipr %>% 
  filter(annee==2013) %>% 
  distinct(sta_id)

sta_aspe_2015<-ipr %>% 
  filter(annee==2015) %>% 
  distinct(sta_id)

sta_aspe_2017<-ipr %>% 
  filter(annee==2017) %>% 
  distinct(sta_id)

sta_aspe_2019<-ipr %>% 
  filter(annee==2019) %>% 
  distinct(sta_id)

sta_aspe_2021<-ipr %>% 
  filter(annee==2021) %>% 
  distinct(sta_id)

sta_aspe_com_1921<-generics :: intersect ( sta_aspe_2019, sta_aspe_2021)

sta_aspe_com_171921<-generics :: intersect ( sta_aspe_2017, sta_aspe_com_1921)

sta_aspe_com_15171921<-generics :: intersect ( sta_aspe_2015, sta_aspe_com_171921)

sta_aspe_com_1315171921<-generics :: intersect ( sta_aspe_2013, sta_aspe_com_15171921)

sta_aspe_com_periode3<-generics :: intersect ( sta_aspe_2011, sta_aspe_com_1315171921)
```

44 stations en commun entre 2019 et 2021. 
40 stations en commun entre 2017, 2019 et 2021. 
19 stations en commun entre 2015, 2017, 2019 et 2021. 
18 stations en commun entre 2013, 2017, 2019 et 2021. 
13 stations en commun les années impaires entre 2010 et 2022. 

```{r}
#construction du vecteur des stations des années impaires 

sta_peche_imp<-c("188", "267", "5253", "5443", "5690", "5953", "5980", "5930", "5503", "4830", "123", "7", "209")
```


### Evolution des IPR et ses métriques

#### Années paires 

Il est à noter que seule une année post-sécheresse est représentée par les années paires. Il n'est donc pas pertinent de créer un  niveau post-sécheresse pour le facteur sécheresse comme pour les macro-invertébrés. Il faut donc mettre l'année post-sécheresse en "sécheresse" ou "pas de sécheresse". Comme la littérature a montré que l'année suivant une sécheresse pouvait êtr fortement impactée par cette sécheresse, voire même plus que l'année sèche elle-même, il a été décidé de classer l'année post sécheresse en "sécheresse". 

```{r}
# selection des stations et des années paires  

ipr_travail<-ipr %>% 
  filter(sta_id %in% sta_peche_paire, annee %in% c("2008",periode2))

# création d'une colonne pour le facteur sécheresse 

ipr_travail[ipr_travail$annee %in% c("2012", "2018", "2020", "2022") ,"secheresse"] <- "secheresse"
ipr_travail[ipr_travail$annee %in% c("2008", "2010", "2014", "2016") ,"secheresse"] <- "pas_secheresse"
 
ipr_travail$secheresse<-ordered(ipr_travail$secheresse, levels=c("pas_secheresse", "secheresse"))
```

```{r}
#Tendance de l'IPR 

ipr_p<-ipr_travail %>% 
ggplot(aes(x=annee, y=ipr, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("IPR")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))

ipr_p
```
```{r}
#test de sheirer ray hare 

scheirerRayHare(ipr~secheresse*annee, data=ipr_travail)

```
Rien n'est significatif. 


```{r}
# IPR par station 

ipr_travail %>% 
  ggplot(aes(x=annee, y=ipr, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
    theme(axis.text = element_text(size = 7))+
  ylab("IPR")+
  facet_wrap(~sta_id)


```

```{r}
#ner tendance 

ner_p<-ipr_travail %>% 
ggplot(aes(x=annee, y=ner, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("NER")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))

ner_p
```


```{r}
#test de sheirer ray hare 

scheirerRayHare(ner~secheresse*annee, data=ipr_travail)
```
Rien de significatif. 


```{r}
#ner par station 

ipr_travail %>% 
  ggplot(aes(x=annee, y=ner, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("NER")+
  facet_wrap(~sta_id)


```

```{r}
# tendance nte 

nte_p<-ipr_travail %>% 
ggplot(aes(x=annee, y=nte, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("NTE")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))

nte_p
```

```{r}
#test de sheirer ray hare 

scheirerRayHare(nte~secheresse*annee, data=ipr_travail)
```
Rien de significatif. 

```{r}
ipr_travail %>% 
  ggplot(aes(x=annee, y=nte, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("NTE")+
  facet_wrap(~sta_id)
```


```{r}
#tendance dit 

dit_p<-ipr_travail %>% 
ggplot(aes(x=annee, y=dit, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("DIT")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))

dit_p
```

```{r}
#test de scheirer ray hare 

scheirerRayHare(dit~secheresse*annee, data=ipr_travail)
```

Rien de significatif. 

```{r}
ipr_travail %>% 
  ggplot(aes(x=annee, y=dit, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("DIT")+
  facet_wrap(~sta_id)
```


```{r}
#tendance nel 

nel_p<-ipr_travail %>% 
ggplot(aes(x=annee, y=nel, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("NEL")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))

nel_p
```


```{r}
#test de scheirer ray hare 

scheirerRayHare(nel~secheresse*annee, data=ipr_travail)
```
Rien de significatif. 

```{r}
#nel à la station 
ipr_travail %>% 
  ggplot(aes(x=annee, y=nel, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("NEL")+
  facet_wrap(~sta_id)

```

```{r}
# tendances dio 

dio_p<-ipr_travail %>% 
ggplot(aes(x=annee, y=dio, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("DIO")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))

dio_p

```


```{r}
#test de scheirer ray hare 

scheirerRayHare(dio~secheresse*annee, data=ipr_travail)
```
Rien de significatif.

```{r}

# dio à la station 

ipr_travail %>% 
  ggplot(aes(x=annee, y=dio, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("DIO")+
  facet_wrap(~sta_id)
```

```{r}
#tendance dii 

dii_p<-ipr_travail %>% 
ggplot(aes(x=annee, y=dii, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("DII")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))

dii_p
```

```{r}
#test de scheirer ray hare 

scheirerRayHare(dii~secheresse*annee, data=ipr_travail)
```

Rien de significatif. 

```{r}
ipr_travail %>% 
  ggplot(aes(x=annee, y=dii, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("DII")+
  facet_wrap(~sta_id)
```

```{r}

# tendence dti 

dti_p<-ipr_travail %>% 
ggplot(aes(x=annee, y=dti, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("DTI")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))

dti_p
```


```{r}
scheirerRayHare(dti~secheresse*annee, data=ipr_travail)
```

Rien de significatif. 

```{r}
ipr_travail %>% 
  ggplot(aes(x=annee, y=dti, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("DTI")+
  facet_wrap(~sta_id)
```

Mettons tous les graphiques de tendance sur un même panneau : 

```{r}
# graphique panneau ipr et métriques 

ggarrange(ipr_p, nte_p, ner_p, nel_p, dit_p, dii_p, dio_p, dti_p, common.legend = TRUE)
```


##### Années impaires 

```{r}
# selection des stations et des années impaires  

ipr_travail_imp<-ipr %>% 
  filter(sta_id %in% sta_peche_imp, annee %in% c(periode3))

# création d'une colonne pour le facteur sécheresse 

ipr_travail_imp[ipr_travail_imp$annee %in% c("2011", "2017", "2019", "2021") ,"secheresse"] <- "secheresse"
ipr_travail_imp[ipr_travail_imp$annee %in% c("2013", "2015") ,"secheresse"] <- "pas_secheresse"
 
ipr_travail_imp$secheresse<-ordered(ipr_travail_imp$secheresse, levels=c("pas_secheresse", "secheresse"))
```


```{r}
#tendance ipr

ipr_i<-ipr_travail_imp %>% 
ggplot(aes(x=annee, y=ipr, group=1, color=secheresse))+
  geom_point(size=0.7)+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("IPR")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
ipr_i
```
```{r}
#test de scheirer 

scheirerRayHare(ipr~secheresse*annee, data=ipr_travail_imp)
```
Rien de significatif. 

```{r} 
#  IPR à la station

ipr_travail_imp %>% 
  ggplot(aes(x=annee, y=ipr, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("IPR")+
  facet_wrap(~sta_id)
```

```{r}
#tendances ner 

ner_i<-ipr_travail_imp %>% 
ggplot(aes(x=annee, y=ner, group=1, color=secheresse))+
  geom_point(size=0.7)+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("NER")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
ner_i

```

```{r}
#test de scheirer 

scheirerRayHare(ner~secheresse*annee, data =ipr_travail_imp)
```

Rien de significatif. 


```{r}
# ner

ipr_travail_imp %>% 
  ggplot(aes(x=annee, y=ner, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("NER")+
  facet_wrap(~sta_id)
```

```{r}
#tendences nel

nel_i<-ipr_travail_imp %>% 
ggplot(aes(x=annee, y=nel, group=1, color=secheresse))+
  geom_point(size=0.7)+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("NEL")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
nel_i
```

```{r}
#test de scheirer 

scheirerRayHare(nel~secheresse*annee, data=ipr_travail_imp)
```

Rien de significatif. 

```{r}
# nel

ipr_travail_imp %>% 
  ggplot(aes(x=annee, y=nel, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("NEL")+
  facet_wrap(~sta_id)
```

```{r}
#tendances nte 
nte_i<-ipr_travail_imp %>% 
ggplot(aes(x=annee, y=nte, group=1, color=secheresse))+
  geom_point(size=0.7)+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("NTE")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
nte_i
```


```{r}
#test de scheirer 

scheirerRayHare(nte~secheresse*annee, data=ipr_travail_imp)
```

Rien de significatif. 


```{r}
# nte 

ipr_travail_imp %>% 
  ggplot(aes(x=annee, y=nte, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("NTE")+
  facet_wrap(~sta_id)
```

```{r}
#tendances dit 

dit_i<-ipr_travail_imp %>% 
ggplot(aes(x=annee, y=dit, group=1, color=secheresse))+
  geom_point(size=0.7)+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("DIT")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
dit_i
```

```{r}
#test de scheirer 

scheirerRayHare(dit~secheresse*annee, data=ipr_travail_imp)
```

RIen de significatif. 

```{r}
# dit

ipr_travail_imp %>% 
  ggplot(aes(x=annee, y=dit, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("DIT")+
  facet_wrap(~sta_id)
```


```{r}
#tendances dio

dio_i<-ipr_travail_imp %>% 
ggplot(aes(x=annee, y=dio, group=1, color=secheresse))+
  geom_point(size=0.7)+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("DIO")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
dio_i
```


```{r}
#test de shceirer 

scheirerRayHare(dio~secheresse*annee, data= ipr_travail_imp)
```


Riend de significatif. 

```{r}
# dio 

ipr_travail_imp %>% 
  ggplot(aes(x=annee, y=dio, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("DIO")+
  facet_wrap(~sta_id)
```

```{r}
#tendances dii 

dii_i<-ipr_travail_imp %>% 
ggplot(aes(x=annee, y=dii, group=1, color=secheresse))+
  geom_point(size=0.7)+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("DII")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
dii_i
```


```{r}
#test de scheirer 

scheirerRayHare(dii~secheresse*annee, data=ipr_travail_imp)
```

Rien de significatif. 

```{r}
# dii 

ipr_travail_imp %>% 
  ggplot(aes(x=annee, y=dii, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("DII")+
  facet_wrap(~sta_id)
```


```{r}
#tendances dti 

dti_i<-ipr_travail_imp %>% 
ggplot(aes(x=annee, y=dti, group=1, color=secheresse))+
  geom_point(size=0.7)+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("DTI")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
dti_i
```


```{r}
#test de scheirer 

scheirerRayHare(dti~secheresse*annee, data=ipr_travail_imp)
```
Rien de significatif. 

```{r}
# dti 

ipr_travail_imp %>% 
  ggplot(aes(x=annee, y=dti, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("DTI")+
  facet_wrap(~sta_id)
```


```{r}
#panneau de graph pour ipr+métriques 

ggarrange(ipr_i, nte_i, ner_i, nel_i, dit_i, dii_i, dio_i, dti_i, common.legend = TRUE)
```

### Evolution de la richesse spécifique 

#### Années paires 

```{r}

mei_travail<-mei_hdf %>% 
  filter(sta_id %in% sta_peche_paire & annee %in% c("2008",periode2)) %>% 
  select(sta_id, pop_libelle:annee, esp_code_alternatif, mei_taille)

mei_travail$annee<-as.factor(mei_travail$annee)
mei_travail$sta_id<-as.factor(mei_travail$sta_id)


# Data frame contant par année le nombre d'individus par espèces et par station

mei_nb_indiv<-mei_travail %>% 
  dplyr::group_by(annee, sta_id, esp_code_alternatif ) %>% 
  dplyr::summarise(nb_tot=n())


mei_nb_indiv[mei_nb_indiv$annee %in% c("2012","2018", "2020", "2022") ,"secheresse"] <- "secheresse"
mei_nb_indiv[mei_nb_indiv$annee %in% c("2008", "2010", "2014", "2016") ,"secheresse"] <- "pas_secheresse"

mei_nb_indiv$secheresse<-as.factor(mei_nb_indiv$secheresse)

```


```{r}
#construction du data frame de la richesse spécifique par année et par station pour les années paires 

mei_rich<-mei_nb_indiv %>% 
  filter(sta_id %in% sta_peche_paire) %>% 
  dplyr::group_by(annee, secheresse, sta_id) %>% 
  dplyr::summarise(richesse=n())
```
 
```{r}
#tendance de la richesse spécifique 

mei_rich %>% 
ggplot(aes(x=annee, y=richesse, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Richesse spécifique")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```

```{r}
#test de scheirer 

scheirerRayHare(richesse~secheresse*annee, data=mei_rich)
```
Rien de significatif. 

On peut noter que l'évolution de la richesse spécifique (nombre d'espèces différentes) ne suit pas la même évolution que la métrique NTE. 


```{r}
# richesse spécifique par station   

mei_rich %>% 
  ggplot(aes(x=annee, y=richesse, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
    theme(axis.text = element_text(size = 7))+
  ylab("Richesse spécifique")+
  facet_wrap(~sta_id)
                    
```


#### Années impaires 

```{r}
mei_travail_imp<-mei_hdf %>% 
  filter(sta_id %in% sta_peche_imp & annee %in% c(periode3)) %>% 
  select(sta_id, pop_libelle:annee, esp_code_alternatif, mei_taille)

mei_travail_imp$annee<-as.factor(mei_travail_imp$annee)
mei_travail_imp$sta_id<-as.factor(mei_travail_imp$sta_id)

# Data frame contant par année le nombre d'individus par espèces et par station

mei_nb_indiv_imp<-mei_travail_imp %>% 
  dplyr::group_by(annee, sta_id, esp_code_alternatif ) %>% 
  dplyr::summarise(nb_tot=n())


mei_nb_indiv_imp[mei_nb_indiv_imp$annee %in% c("2011", "2017", "2019", "2021") ,"secheresse"] <- "secheresse"
mei_nb_indiv_imp[mei_nb_indiv_imp$annee %in% c("2013", "2015") ,"secheresse"] <- "pas_secheresse"

mei_nb_indiv_imp$secheresse<-as.factor(mei_nb_indiv_imp$secheresse)

```


```{r}
#construction du data frame de la richesse spécifique par année et par station pour les années paires 

mei_rich_imp<-mei_nb_indiv_imp %>% 
  filter(sta_id %in% sta_peche_imp) %>% 
  dplyr::group_by(annee, secheresse, sta_id) %>% 
  dplyr::summarise(richesse=n())
```


```{r}

mei_rich_imp %>% 
ggplot(aes(x=annee, y=richesse, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Richesse spécifique")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```

```{r}
#test de scheirer 

scheirerRayHare(richesse~secheresse*annee, data=mei_rich_imp)
```

Rien de significatif. 


### Composition des communautés 

L'idée est de voir, avec une vision graphique, si  la composition de la communauté de poissons change en fonction des années et de la modalité de sécheresse. L'idée n'est pas (sauf gros changement identifié) de faire des test statistiques. C'est pour cela que la modalité post_secheresse peut être conservée à  la fois pour les années paires et impaires même si une seule année la représente. 

#### Années paires 

##### Calcul des effectifs relatifs par espèce et par année  

```{r} 

# Construction du data frame 

#calcule du nombre d'individus par espèce pour une station et une années données 
mei_nte_sta<-mei_travail %>% 
  dplyr::group_by(sta_id,annee, esp_code_alternatif) %>% 
  dplyr::summarise(nb_tot=n()) 

# ajout de la colonne de moldaité de sécheresse 

mei_nte_sta[mei_nte_sta$annee %in% c("2018", "2020", "2022") ,"secheresse"] <- "secheresse" 
mei_nte_sta[mei_nte_sta$annee=="2012", "secheresse"] <- "post_secheresse"
mei_nte_sta[mei_nte_sta$annee %in% c("2008", "2010", "2014", "2016") ,"secheresse"] <- "pas_secheresse"


#conversion de la colonne de sécheresse en facteur 
mei_nte_sta$secheresse<-as.factor(mei_nte_sta$secheresse)


# Calcule du nombre total d'individus capturé par années et par station 

# calcule du nombre total d'individus capturé pour chaque pêche (une station et une année)
tot_peche<-mei_travail %>% 
  dplyr::group_by(sta_id, annee) %>% 
  dplyr::summarise(nb_tot_peche=n())

#ajout par jointure d'une colonne du nombre total d'individus par pêche au data frame du nombre d'individus par espèces 
mei_nte_sta<-merge(tot_peche,mei_nte_sta, by=c("sta_id","annee"))


```

Le data frame mei_nte_sta contient maintenant l'annee, le identifiant de station, le nombre total d'individus pêchés pour cette année à cette station (nb_tot_peche), le code espèce et le nombre d'individus pêchés par espèce (nb_tot).

```{r}
# Calcule des effectifs par espèces par années par station 

mei_nte_sta<- mei_nte_sta %>% 
  mutate(effectif=(nb_tot/nb_tot_peche)*100)
```

Une colonne effectif (effectif relatif) a été rajoutée qui donne en pourcentage l'effectif relatif (nombre d'individus de l'espèce capturés sur le nombre total d'individus capturés) de l'espèce pour une station et une année données. 

```{r}
#sauvegarde en RData du tableau des effectifs par station 

save(mei_nte_sta, file="processed_data/effectifs_especes_stations.RData")
```

On peut réaliser les mêmes manipulations pour avoir les effectifs relatifs des espèces sur l'ensemble des 20 stations pour chaque année. 

```{r}
#nombre total d'individus par espèces et par année 

mei_nti_esp<-mei_nte_sta %>% 
  dplyr::group_by(annee, secheresse, esp_code_alternatif) %>% 
  dplyr::summarise(nb_indiv=sum(nb_tot))
```

```{r}
#nombre d'individus capturés chaque année 

tot_peche_reg<-mei_travail %>% 
  dplyr::group_by(annee) %>% 
  dplyr::summarise(nb_tot_peche=n())
```

```{r}

#ajout de la colonne du nombre total d'individus capturés par année 

mei_nti_esp<-merge(tot_peche_reg,mei_nti_esp, by="annee")
```

```{r}
# Calcule des effectifs par espèces par années 

mei_nti_esp<- mei_nti_esp %>% 
  mutate(effectif_relatif=(nb_indiv/nb_tot_peche)*100)
```


```{r}
#représentation en bubble plot de la cooomunuaté sur les 20 stations 

mei_nti_esp %>% 
  ggplot(aes(x = annee, y = esp_code_alternatif)) + 
  geom_point(aes(size = effectif_relatif, fill = secheresse),alpha=0.65, shape = 21)+ # création de point de taille selon effectif
  scale_size(range = c(1, 5), breaks = c(1,20,40,60))+ # ajustement de la légende (taille de cercle, valeurs indiquées)
  theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.y = element_text(size = 5)) +
  ylab("Espèces")+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```

##### Représentation graphique en bubble plot de l'évolution des effectifs par station 

```{r}
mei_nte_sta %>% 
  filter(sta_id=="7") %>%  #%in% c("7", "48", "92", "109", "137","149")) %>% # choix des stations à affichier (ici 6 sur 20 pour une question de lisibilité)
  ggplot(aes(x = annee, y = esp_code_alternatif)) + 
  geom_point(aes(size = effectif, fill = secheresse),alpha=0.65, shape = 21)+ # création de point de taille selon effectif
  scale_size(range = c(1, 5), breaks = c(1,20,40,60))+ # ajustement de la légende (taille de cercle, valeurs indiquées)
  theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.y = element_text(size = 5)) +
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free') # plot des résultats selon la station (un panneau par station) sur le même graph 


```

On peut ajouter à ces graphiques en bulles la courbe de la richesse spécifique (nombre d'espèces) par année et par station. 

```{r}
mei_nte_sta %>% 
  dplyr::group_by(sta_id, annee, secheresse) %>% 
  dplyr::summarise(richesse=n()) %>% 
  filter(sta_id %in% c("7", "48", "92", "109", "137","149")) %>% 
  ggplot(aes(x=annee, y=richesse, group=1, color=secheresse))+
  geom_point()+
  geom_line(stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free')
  
```

```{r}
mei_nte_sta %>% 
  filter(sta_id %in% c("154", "169", "209", "262", "4830","5307")) %>% # choix des stations à affichier (ici 6 sur 20 pour une question de lisibilité)
  ggplot(aes(x = annee, y = esp_code_alternatif)) + 
  geom_point(aes(size = effectif, fill = secheresse),alpha=0.65, shape = 21)+ # création de point de taille selon effectif
  scale_size(range = c(1, 5), breaks = c(1,20,40,60))+ # ajustement de la légende (taille de cercle, valeurs indiquées)
  theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.y = element_text(size = 5)) +
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free') # plot des résultats selon la station (un panneau par station) sur le même graph 

```
```{r}
mei_nte_sta %>% 
  dplyr::group_by(sta_id, annee, secheresse) %>% 
  dplyr::summarise(richesse=n()) %>% 
  filter(sta_id %in% c("154", "169", "209", "262", "4830","5307")) %>% 
  ggplot(aes(x=annee, y=richesse, group=1, color=secheresse))+
  geom_point()+
  geom_line(stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free')
```

```{r}
mei_nte_sta %>% 
  filter(sta_id %in% c("5355", "5503", "5534", "5722", "5930","5980")) %>% # choix des stations à affichier (ici 6 sur 20 pour une question de lisibilité)
  ggplot(aes(x = annee, y = esp_code_alternatif)) + 
  geom_point(aes(size = effectif, fill = secheresse),alpha=0.65, shape = 21)+ # création de point de taille selon effectif
  scale_size(range = c(1, 5), breaks = c(1,20,40,60))+ # ajustement de la légende (taille de cercle, valeurs indiquées)
  theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.y = element_text(size = 5)) +
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free') 
```

```{r}
mei_nte_sta %>% 
  dplyr::group_by(sta_id, annee, secheresse) %>% 
  dplyr::summarise(richesse=n()) %>% 
  filter(sta_id %in% c("5355", "5503", "5534", "5722", "5930","5980")) %>% 
  ggplot(aes(x=annee, y=richesse, group=1, color=secheresse))+
  geom_point()+
  geom_line(stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free')
```

```{r}
eff_61<-mei_nte_sta %>% 
  filter(sta_id %in% c("6134", "6189")) %>% # choix des stations à affichier (ici 6 sur 20 pour une question de lisibilité)
  ggplot(aes(x = annee, y = esp_code_alternatif)) + 
  geom_point(aes(size = effectif, fill = secheresse),alpha=0.65, shape = 21)+ # création de point de taille selon effectif
  scale_size(range = c(1, 5), breaks = c(1,20,40,60))+ # ajustement de la légende (taille de cercle, valeurs indiquées)
  theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.y = element_text(size = 5)) +
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free') 

rich_61<-mei_nte_sta %>% 
  dplyr::group_by(sta_id, annee, secheresse) %>% 
  dplyr::summarise(richesse=n()) %>% 
  filter(sta_id %in% c("6134", "6189")) %>% 
  ggplot(aes(x=annee, y=richesse, group=1, color=secheresse))+
  geom_point()+
  geom_line(stat="identity")+
  theme(axis.text.x = element_text(angle = 90))+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free')

ggarrange(eff_61, rich_61, ncol=1, nrow=2, common.legend=TRUE)

```


Essai de graphique sur la richesse spécifique par station sur la période 2010-2022 sur le même graphique : 

```{r}
richesse_spe_paire<-mei_nte_sta %>% 
  dplyr::group_by(sta_id, annee, secheresse) %>% 
  dplyr::summarise(richesse=n())
```

```{r}

richesse_spe_paire$annee<-as.numeric(richesse_spe_paire$annee)

richesse_spe_paire %>% 
  ggplot(aes(x=annee, y=richesse, color=sta_id))+
  geom_point()+
  geom_line()+
  theme(axis.text.x = element_text(angle = 90))+ 
  scale_color_manual(values = palette)
```



#### Années impaires 

```{r}
# Construction du data frame 

#calcule du nombre d'individus par espèce pour une station et une années données 
mei_nte_sta_imp<-mei_travail_imp %>% 
  dplyr::group_by(sta_id,annee, esp_code_alternatif) %>% 
  dplyr::summarise(nb_tot=n()) 

# ajout de la colonne de moldaité de sécheresse 

mei_nte_sta_imp[mei_nte_sta_imp$annee %in% c("2011", "2017", "2019") ,"secheresse"] <- "secheresse" 
mei_nte_sta_imp[mei_nte_sta_imp$annee=="2021", "secheresse"] <- "post_secheresse"
mei_nte_sta_imp[mei_nte_sta_imp$annee %in% c("2013", "2015") ,"secheresse"] <- "pas_secheresse"

#conversion de la colonne de sécheresse en facteur 
mei_nte_sta_imp$secheresse<-as.factor(mei_nte_sta_imp$secheresse)


# Calcule du nombre total d'individus capturé par années et par station 

# calcule du nombre total d'individus capturé pour chaque pêche (une station et une année)
tot_peche_imp<-mei_travail_imp %>% 
  dplyr::group_by(sta_id, annee) %>% 
  dplyr::summarise(nb_tot_peche=n())

#ajout par jointure d'une colonne du nombre total d'individus par pêche au data frame du nombre d'individus par espèces 
mei_nte_sta_imp<-merge(tot_peche_imp,mei_nte_sta_imp, by=c("sta_id","annee"))

```

```{r}
# Calcule des effectifs par espèces par années par station 

mei_nte_sta_imp<- mei_nte_sta_imp %>% 
  mutate(effectif=(nb_tot/nb_tot_peche)*100)
```


```{r}
#sauvegarde en RData du tableau des effectifs par station 

save(mei_nte_sta_imp, file="processed_data/effectifs_especes_stations_imp.RData")
```

On peu réaliser la même manipulation pour la communauté sur l'ensemble des stations : 


```{r}
#nombre total d'individus par espèces et par année 

mei_nti_esp_imp<-mei_nte_sta_imp %>% 
  dplyr::group_by(annee, secheresse, esp_code_alternatif) %>% 
  dplyr::summarise(nb_indiv=sum(nb_tot))
```

```{r}
#nombre d'individus capturés chaque année 

tot_peche_reg_imp<-mei_travail_imp %>% 
  dplyr::group_by(annee) %>% 
  dplyr::summarise(nb_tot_peche=n())
```

```{r}

#ajout de la colonne du nombre total d'individus capturés par année 

mei_nti_esp_imp<-merge(tot_peche_reg_imp,mei_nti_esp_imp, by="annee")
```

```{r}
# Calcule des effectifs par espèces par années 

mei_nti_esp_imp<- mei_nti_esp_imp %>% 
  mutate(effectif_relatif=(nb_indiv/nb_tot_peche)*100)
```


```{r}
#représentation en bubble plot de la cooomunuaté sur les 20 stations 

mei_nti_esp_imp %>% 
  ggplot(aes(x = annee, y = esp_code_alternatif)) + 
  geom_point(aes(size = effectif_relatif, fill = secheresse),alpha=0.65, shape = 21)+ # création de point de taille selon effectif
  scale_size(range = c(1, 5), breaks = c(1,10,20))+ # ajustement de la légende (taille de cercle, valeurs indiquées)
  theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.y = element_text(size = 5)) +
  ylab("Espèces")+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```


##### Représentation bubble plot par station 

```{r}
mei_nte_sta_imp %>% 
  filter(sta_id %in% c("7", "123", "188", "209", "267","4830")) %>% # choix des stations à affichier (ici 5 sur 13 pour une question de lisibilité)
  ggplot(aes(x = annee, y = esp_code_alternatif)) + 
  geom_point(aes(size = effectif, fill = secheresse),alpha=0.65, shape = 21)+ # création de point de taille selon effectif
  scale_size(range = c(1, 5), breaks = c(1,20,40,60))+ # ajustement de la légende (taille de cercle, valeurs indiquées)
  theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.y = element_text(size = 5)) +
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free')
```

```{r}
mei_nte_sta_imp %>% 
  filter(sta_id %in% c("5443", "5690","5503", "5930", "5953", "5253")) %>% # choix des stations à affichier (ici 5 sur 13 pour une question de lisibilité)
  ggplot(aes(x = annee, y = esp_code_alternatif)) + 
  geom_point(aes(size = effectif, fill = secheresse),alpha=0.65, shape = 21)+ # création de point de taille selon effectif
  scale_size(range = c(1, 5), breaks = c(1,20,40,60))+ # ajustement de la légende (taille de cercle, valeurs indiquées)
  theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.y = element_text(size = 5)) +
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free')
```


```{r}
mei_nte_sta_imp %>% 
  filter(sta_id=="5980") %>% # choix des stations à affichier (ici 5 sur 13 pour une question de lisibilité)
  ggplot(aes(x = annee, y = esp_code_alternatif)) + 
  geom_point(aes(size = effectif, fill = secheresse),alpha=0.65, shape = 21)+ # création de point de taille selon effectif
  scale_size(range = c(1, 5), breaks = c(1,20,40,60))+ # ajustement de la légende (taille de cercle, valeurs indiquées)
  theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.y = element_text(size = 5)) +
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id, scale='free')
```

### Evolution des tailles de poissons 

Le but est de tester si le facteur sécheresse a une influence sur la taille (en mm) des individus. Comme celle-ci dépend énormément de l'espèce considérée, il serait bien de pouvoir étudier un modèle linéaire mixte, avec l'espèce en facteur aléatoire. 

Comme nous effectuons des tests statistiques avec le facteur secheresse, les années post-sécheresse sont considérées commme faisant partie de la modalité sécheresse. 

Quelques espèces cibles seront aussi étudiées, à la fois des espèces d'eau chaude, intermédiare et des espèces d'eau froide, qui sont présentes tous les ans dans la région. 

Ces espèces sont : 

-CHA (eau froide) -> espèce en général la plus abondante 
-ROT(eau chaude)
-TRF (eau froide)
-TAC (eau froide)
-VAN (intermédiaire, optimum max 25°C)
-PER (supporte bien les gros écart de température)
-BRO (?)


#### Années paires 

```{r}
mei_travail[mei_travail$annee %in% c("2012", "2018", "2020", "2022") ,"secheresse"] <- "secheresse" 
mei_travail[mei_travail$annee %in% c("2008", "2010", "2014", "2016") ,"secheresse"] <- "pas_secheresse"

mei_travail$secheresse<-as.factor(mei_travail$secheresse)
mei_travail$esp_code_alternatif<-as.factor(mei_travail$esp_code_alternatif)
mei_travail$mei_taille<-as.numeric(mei_travail$mei_taille)
```


```{r}
# construction d'un modèle mixte linéaire 

MLM_taille<-lme4::lmer(mei_taille~secheresse+(1|esp_code_alternatif)+(1|sta_id), data=mei_travail)

summary(MLM_taille)

```
```{r}
plot(MLM_taille)
```

```{r}
plot(resid(MLM_taille),mei_travail$mei_taille)
```

```{r}
qqmath(MLM_taille)
```

Les hypothèses de validité du modèle ne sont pas respectées.


```{r}
scheirerRayHare(mei_taille~secheresse+esp_code_alternatif, data=mei_travail)
```


```{r}
comparison<-with(mei_travail,kruskal(mei_taille,secheresse, group=TRUE, p.adj = "bon"))
comparison
```


```{r}
kruskal.test(mei_taille~secheresse, data=mei_travail)
```

Les tests indiquent un effet significatif de la modalité de sécheresse sur la taille des poissons, avec une médiane du groupe sécheresse plus faible que celle du groupe pas_secheresse. Cela parait quand même étrange vu les distributions quasi indentiques, mais c'est un résultat, probablement à critiquer. 

```{r}
mei_travail %>% 
  ggplot(aes(x=secheresse, y=mei_taille, fill=secheresse))+
  geom_boxplot(outlier.shape=NA)+
  ylab("Taille (en mm)")+
  ylim(0,500)+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```

```{r}
mei_travail%>% 
  dplyr::group_by(annee, secheresse, sta_id) %>% 
  dplyr::summarise(med_taille=median(mei_taille)) %>% 
ggplot(aes(x=annee, y=med_taille, fill=secheresse))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Taille (en mm)")+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~sta_id)
```


##### Chabot (CHA)

```{r}
#data frame contant uniquement les mesures de tailles des Chabots 

taille_CHA<-mei_travail %>% 
  filter(esp_code_alternatif=="CHA")

```

```{r, eval=FALSE}
# construction d'un modèle linéaire mixte 

MLM_CHA<-lmer(mei_taille~secheresse+(1|sta_id), data=taille_CHA)

summary(MLM_CHA)

```

```{r}
qqmath(MLM_CHA)

```
 Les hypothèses de validité ne sont respectées. 

```{r}
#test de Kruskal Wallis

kruskal.test(mei_taille~secheresse, data=taille_CHA)

kruskal.test(mei_taille~annee, data=taille_CHA)
```

La p-value est très significative, ce qui voudrait dire que la modalité de sécheresse a une influence très significative sur la taille des chabots (idem pour l'année). Mais ça parait très bizarre ...

```{r}

#comparaison par paires de dunn

library(FSA)
dunnTest(mei_taille~secheresse, data=taille_CHA)

```

Les trois comparaisons sont significatives (très significatives ...), ce qui voudrait dire que les tailles des chabots sont significativement différentes selon les modalités des sécheresse. Mais ça n'a aucun sens au vu des graphiques ci dessous...

```{r}
# distribution des tailles de chabot par année

taille_CHA %>% 
  ggplot(aes(x=annee, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  ggtitle("Chabot")

  
```
Il ne semble pas y avoir de tendence... pourquoi le test de Kruskal Wallis affiche une p-value aussi significative ??

```{r}
#distribution des tailles de chabot par modalité de sécheresse 

taille_CHA %>% 
  ggplot(aes(x=secheresse, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  ggtitle("Chabot")
```
Les distributions sont quasi égales, pourquoi Kruskal Walli et Dunn sont significatifs ????? Ca n'a aucun sens.

Peut-être qu'en essayant à la station les résultats seront plus cohérents : 

```{r}
#essai sur la station 7

CHA_7<-taille_CHA %>% 
  filter(sta_id=="7")

kruskal.test(data=CHA_7, mei_taille~secheresse)

kruskal.test(data=CHA_7, mei_taille~annee)

```
Le test est aussi significatif.

```{r}
CHA_7 %>% 
  ggplot(aes(x=secheresse, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  ggtitle("Chabot")
```
```{r}
taille_CHA %>% 
  ggplot(aes(x=annee, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  facet_wrap(~sta_id)
```
Peut-être que les tests donnent des résultats abhérents parce que les obervations ne sont pas indépendentes : la taille de poissons de l'année n dépend de celle de l'année n-1. 

##### Rotengle 

```{r}
taille_ROT<-mei_travail %>% 
  filter(esp_code_alternatif=="ROT")

taille_ROT %>% 
  ggplot(aes(x=annee, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  facet_wrap(~sta_id)
```
##### Truite de rivière 

```{r}
taille_TRF<-mei_travail %>% 
  filter(esp_code_alternatif=="TRF")

taille_TRF %>% 
  ggplot(aes(x=annee, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  facet_wrap(~sta_id)
```

##### Truite arc en ciel 

```{r}
taille_TAC<-mei_travail %>% 
  filter(esp_code_alternatif=="TAC")

taille_TAC %>% 
  ggplot(aes(x=annee, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  facet_wrap(~sta_id)
```
##### Vandoise 

```{r}
taille_VAN<-mei_travail %>% 
  filter(esp_code_alternatif=="VAN")

taille_VAN %>% 
  ggplot(aes(x=annee, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  facet_wrap(~sta_id)
```
#### Perche 

```{r}
taille_PER<-mei_travail %>% 
  filter(esp_code_alternatif=="PER")

taille_PER %>% 
  ggplot(aes(x=annee, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  facet_wrap(~sta_id)
```


#### Brochet 

```{r}
taille_BRO<-mei_travail %>% 
  filter(esp_code_alternatif=="BRO")

taille_BRO %>% 
  ggplot(aes(x=annee, y=mei_taille, fill=secheresse))+
  geom_boxplot()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  facet_wrap(~sta_id)
```


### Années impaires 

```{r}
mei_travail_imp[mei_travail_imp$annee %in% c("2011", "2017", "2019", "2021") ,"secheresse"] <- "secheresse" 
mei_travail_imp[mei_travail_imp$annee %in% c("2013", "2015") ,"secheresse"] <- "pas_secheresse"

mei_travail_imp$secheresse<-as.factor(mei_travail_imp$secheresse)
mei_travail_imp$esp_code_alternatif<-as.factor(mei_travail_imp$esp_code_alternatif)
mei_travail_imp$mei_taille<-as.numeric(mei_travail_imp$mei_taille)

```


```{r}
scheirerRayHare(mei_taille~secheresse*annee, data=mei_travail_imp)
```
Effet de l'année mais pas des autres. 

```{r}
comparison<-with(mei_travail_imp, kruskal(mei_taille,annee, group=TRUE, p.adj = "bon"))
comparison
```

## Evolution des paramètres macro-invertébrés 

## Chargement des data frame de taxons et d'I2M2/métriques 

```{r}
load(file="raw_data/i2m2_hdf.RData")
i2m2_hdf$code_station_hydrobio<-as.character(i2m2_hdf$code_station_hydrobio)

load(file="raw_data/taxons_macro_hdf.RData")

taxons_macro_hdf<-taxons_macro_hdf %>% 
  mutate(annee=substr(date_prelevement,1,4))
taxons_macro_hdf$annee<-as.factor(taxons_macro_hdf$annee)

taxons_macro_hdf[taxons_macro_hdf$annee %in% c("2011","2017", "2018", "2019", "2020", "2022") ,"secheresse"] <- "secheresse"
taxons_macro_hdf[taxons_macro_hdf$annee %in% c("2012", "2021"), "secheresse"] <- "post_secheresse"
taxons_macro_hdf[taxons_macro_hdf$annee %in% c( "2010", "2013","2014","2015", "2016") ,"secheresse"] <- "pas_secheresse"

```


### Identification des stations utilisables pour l'I2M2 

Les résultats d'I2M2 ne sont disponibles que depuis 2013 (à la fois depuis l'API hydrométrie et sur Naïades), puisque cet indice n'a été créé officiellement que depuis 2014 (d'après Eaufrance). L'indicateurs macro-invertébrés utilisé auparavant était l'indicateur IBG-DCE. De plus, il n'a encore aucune données d'I2M2 pour l'année 2022. 

L'utilisation d'un nouvel indice empêche l'étude d'une longue chronique, puisque les années ne sont pas comparables si l'indice utilisé n'est pas le même. De plus, les années les plus intéressantes pour une étude sécheresse sont les dernières années depuis 2017 (évènements de sécheresse réccurents), ce qui impose l'utilisation de l'I2M2 comme indice (celui utilisé ces années-là). 

Toutefois, il est possible, à partir des listes faunistiques de recalculer l'indicateur I2M2 via le SEEE. 

```{r}
#nombre d'i2m2 par an 

i2m2_hdf %>% 
  filter(code_indice=="7613") %>% 
 ggplot(aes(x=annee))+geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white")
```

On constate qu'on retrouve quasiment le même nombre de données d'i2m2 les années 2018 et 2020 et 2019 et 2021. On peut donc supposer que les stations des années paires sont les mêmes depuis 2018 et pareillement pour les années impaires. On peut le vérifier : 

```{r}
sta_hrb_2018<-i2m2_hdf %>% 
filter(annee==2018 & code_indice=="7613") %>% 
distinct(code_station_hydrobio)

sta_hrb_2020<-i2m2_hdf %>% 
filter(annee==2020 & code_indice=="7613") %>% 
distinct(code_station_hydrobio)

sta_hrb_2019<-i2m2_hdf %>% 
filter(annee==2019 & code_indice=="7613") %>% 
distinct(code_station_hydrobio)

sta_hrb_2021<-i2m2_hdf %>% 
filter(annee==2021 & code_indice=="7613") %>% 
distinct(code_station_hydrobio)

sta_hrb_2017<-i2m2_hdf %>% 
filter(annee==2017 & code_indice=="7613") %>% 
distinct(code_station_hydrobio)

sta_hrb_2016<-i2m2_hdf %>% 
filter(annee==2016 & code_indice=="7613") %>% 
distinct(code_station_hydrobio)

sta_hrb_2015<-i2m2_hdf %>% 
filter(annee==2015 & code_indice=="7613") %>% 
distinct(code_station_hydrobio)

sta_hrb_2014<-i2m2_hdf %>% 
filter(annee==2014 & code_indice=="7613") %>% 
distinct(code_station_hydrobio)

```


#### Identifications des stations (et de la période max) pour un suivi tous les ans 

```{r}
#intersection des années 2018 et 2020 et 2019 et 2021

sta_hrb_com_1820<-generics :: intersect ( sta_hrb_2018, sta_hrb_2020)

sta_hrb_com_1921<-generics :: intersect ( sta_hrb_2019,
                                           sta_hrb_2021)

```

Il y a 92 stations communes aux années 2018 et 2020 et aussi aux années 2019 et 2021. Voyons si ces stations sont les mêmes. 

```{r}

sta_hrb_com_18a21<-generics :: intersect ( sta_hrb_com_1820,sta_hrb_2016)
                                           
```

Il y a 78 stations en commun entre les années 2018, 2019, 2020 et 2021. Continuons à voir si ces stations sont croisables avec d'autres années : 

```{r}
sta_hrb_com_17a21<-generics :: intersect (sta_hrb_com_18a21,sta_hrb_2017)

sta_hrb_com_16a21<-generics :: intersect (sta_hrb_com_17a21,sta_hrb_2016)

sta_hrb_com_15a21<-generics :: intersect (sta_hrb_com_16a21,sta_hrb_2015)

sta_hrb_com_14a21<-generics :: intersect (sta_hrb_com_15a21,sta_hrb_2014)


```

Lorsque l'on rajoute les années 2017 et 2016, on tombe à 14 stations en commun à toutes les années entre 2016 et 2021 (l'ajout de l'année 2016 ne fait pas baisser ce nom, qui est le même avec uniquement l'ajout de 2017). Avec l'ajout de 2015, on tombe à 11 stations et avec l'ajout de 2014 on ne retrouve plus aucune station en commun. 

#### Identifications des stations (et de la période max) pour un suivi les années paires 

```{r}
sta_hrb_com_161820<-generics :: intersect (sta_hrb_com_1820,sta_hrb_2016)

sta_hrb_com_14161820<-generics :: intersect (sta_hrb_com_161820,sta_hrb_2014)

```

Les années paires des 2016 à 2020 (soit 3 années) ont 26 stations en commun. Lorsque l'on rajoute 2014, il n'y a plus aucune station en commun. 

#### Identifications des stations (et de la période max) pour un suivi les années impaires 

```{r}
sta_hrb_com_171921<-generics :: intersect (sta_hrb_com_1921,sta_hrb_2017)

sta_hrb_com_15171921<-generics :: intersect (sta_hrb_com_171921,sta_hrb_2015)
```

Les années impaires de 2015 à 2021 (soit 4 années) ont 11 stations en commun. Sans l'année 2015, ce nombre monte à 16 stations.


### Identification des stations utilisables pour l'étude des taxons 

```{r}
# nombre de stations par année avec une liste faunistique 

taxons_macro_hdf %>% 
  dplyr::group_by(annee,code_station_hydrobio) %>% 
  dplyr::summarise(total_indiv=sum(resultat_taxon)) %>% 
 ggplot(aes(x=annee))+geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white")
```


```{r}
sta_hrb_tx_2018<-taxons_macro_hdf %>% 
filter(annee==2018) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2020<-taxons_macro_hdf %>% 
filter(annee==2020) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2019<-taxons_macro_hdf %>% 
filter(annee==2019) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2021<-taxons_macro_hdf %>% 
filter(annee==2021) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2017<-taxons_macro_hdf %>% 
filter(annee==2017) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2016<-taxons_macro_hdf %>% 
filter(annee==2016 ) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2015<-taxons_macro_hdf %>% 
filter(annee==2015) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2014<-taxons_macro_hdf %>% 
filter(annee==2014) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2013<-taxons_macro_hdf %>% 
filter(annee==2013) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2012<-taxons_macro_hdf %>% 
filter(annee==2012) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2011<-taxons_macro_hdf %>% 
filter(annee==2011) %>% 
distinct(code_station_hydrobio)

sta_hrb_tx_2010<-taxons_macro_hdf %>% 
filter(annee==2010) %>% 
distinct(code_station_hydrobio)
```

```{r}
sta_tx_com2021<-generics::intersect(sta_hrb_tx_2021, sta_hrb_tx_2020)

sta_tx_com19a21<-generics::intersect(sta_hrb_tx_2019, sta_tx_com2021)

sta_tx_com18a21<-generics::intersect(sta_hrb_tx_2018, sta_tx_com19a21)

sta_tx_com17a21<-generics::intersect(sta_hrb_tx_2017, sta_tx_com18a21)

sta_tx_com16a21<-generics::intersect(sta_hrb_tx_2016, sta_tx_com17a21)

sta_tx_com15a21<-generics::intersect(sta_hrb_tx_2015, sta_tx_com16a21)

sta_tx_com14a21<-generics::intersect(sta_hrb_tx_2014, sta_tx_com15a21)

sta_tx_com13a21<-generics::intersect(sta_hrb_tx_2013, sta_tx_com14a21)

sta_tx_com12a21<-generics::intersect(sta_hrb_tx_2012, sta_tx_com13a21)

sta_tx_com11a21<-generics::intersect(sta_hrb_tx_2011, sta_tx_com12a21)

sta_tx_com10a21<-generics::intersect(sta_hrb_tx_2010, sta_tx_com11a21)

```

Il y a en tout 19 stations en commun chaque année entre 2010 et 2021.

Nombre de stations en commun entre : 
-2020 et 2021 : 89
-2019 à 2021 : 89
-2018 à 2021 : 87 
-2017 à 2021 : 25 
-2016 à 2021 : 25 
-2015 à 2021 : 22 
-2014 à 2021 : 22 
-2013 à 2021 : 21 
-2012 à 2021 : 21
-2011 à 2021 : 20
-2010 à 2021 : 19

```{r}
# création d'un vecteur contenant ces stations 

sta_hrb_tx<-as.character(sta_tx_com10a21$code_station_hydrobio)

```



En observant le data frame, on constate qu'il y a un problème avec les données de phase : les phases ne sont pas annotées de la même manière selon les années, parfois elle sont du type B1, B2, B3, des fois du type A, B,C, C' ou encore numérotées de 1 à 12 ou de p1 à p12. 

Grâce à Yves-Marie HENO du laboratoire d'hydrobiologie, les libellés de phases ont été standardisés. De plus, il a recalculé, à partir des liste faunistiques grâce à un script R tiré des fonctions du SEEE, les I2M2 et leurs métriques pour toutes les données de taxons disponibles. Les stations selectionnées pour l'étude des taxons pourront donc aussi être utilsiées pour une étude de l'I2M2 et de ses métriques. 

La tableau d'I2M2 et ses métriques est disponible dans le RData "I2M2.Rda" et les scripts qui ont permis de mettre en forme le tableau d'indicateur de l'API et de calculer l'indicateurs et ses métriques sont aussi disponibles, dans les fichiers R scripts minvHDF_I2M2.R et 30_calcule_SEEE_I2M2_eptb.R. 


```{r}
#importation du data frame d'I2M2 et ses métriques 

load(file="raw_data/I2M2.Rda")

Tableau_i2m2_metriques$LIB_PAR<-as.factor(Tableau_i2m2_metriques$LIB_PAR)
Tableau_i2m2_metriques$CODE_STATION<-as.factor(Tableau_i2m2_metriques$CODE_STATION)
Tableau_i2m2_metriques$DATE<-ymd(Tableau_i2m2_metriques$DATE)

Tableau_i2m2_metriques<-Tableau_i2m2_metriques %>% 
  mutate(annee=substr(DATE, 1,4))

Tableau_i2m2_metriques$annee<-as.factor(Tableau_i2m2_metriques$annee)

Tableau_i2m2_metriques[Tableau_i2m2_metriques$annee %in% c("2011", "2017", "2018", "2019", "2020") ,"secheresse"] <- "secheresse" 
Tableau_i2m2_metriques[Tableau_i2m2_metriques$annee %in% c("2012", "2021"),  "secheresse"] <- "post_secheresse"
Tableau_i2m2_metriques[Tableau_i2m2_metriques$annee %in% c("2010", "2013", "2014", "2015", "2016") ,"secheresse"] <- "pas_secheresse"

Tableau_i2m2_metriques$secheresse<-ordered(Tableau_i2m2_metriques$secheresse, levels=c("pas_secheresse", "secheresse", "post_secheresse"))

Tableau_i2m2_metriques<-Tableau_i2m2_metriques %>% 
  drop_na() %>% # suppression des NA 
  unique()



```

## Selection des stations 

Pour quelques stations, le calcul d'indicateur et de métriques n'a pas pu être fait, car la typologie du cours n'a pas pu être prise en compte dans le calcul. Il est donc probable que les 19 stations identifiées comme ayant de la donnée en continue sur les années 2010-2021 ne soient plus au nombre de 19. C'est pour cela que l'identifiation des stations en commun sur toutes les années de  2010 à 2021 est refaite ci-dessous. 

```{r}
sta_hrb_ind_2018<-Tableau_i2m2_metriques %>% 
filter(annee==2018 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2020<-Tableau_i2m2_metriques %>% 
filter(annee==2020  & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2019<-Tableau_i2m2_metriques %>% 
filter(annee==2019 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2021<-Tableau_i2m2_metriques %>% 
filter(annee==2021 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2017<-Tableau_i2m2_metriques %>% 
filter(annee==2017 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2016<-Tableau_i2m2_metriques %>% 
filter(annee==2016 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2015<-Tableau_i2m2_metriques %>% 
filter(annee==2015 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2014<-Tableau_i2m2_metriques %>% 
filter(annee==2014 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2013<-Tableau_i2m2_metriques %>% 
filter(annee==2013 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2012<-Tableau_i2m2_metriques %>% 
filter(annee==2012 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2011<-Tableau_i2m2_metriques %>% 
filter(annee==2011 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)

sta_hrb_ind_2010<-Tableau_i2m2_metriques %>% 
filter(annee==2010 & LIB_PAR=="Ind Invert Multimetrique") %>% 
distinct(CODE_STATION)
```

```{r}
sta_ind_com2021<-generics::intersect(sta_hrb_ind_2021, sta_hrb_ind_2020)

sta_ind_com19a21<-generics::intersect(sta_hrb_ind_2019, sta_ind_com2021)

sta_ind_com18a21<-generics::intersect(sta_hrb_ind_2018, sta_ind_com19a21)

sta_ind_com17a21<-generics::intersect(sta_hrb_ind_2017, sta_ind_com18a21)

sta_ind_com16a21<-generics::intersect(sta_hrb_ind_2016, sta_ind_com17a21)

sta_ind_com15a21<-generics::intersect(sta_hrb_ind_2015, sta_ind_com16a21)

sta_ind_com14a21<-generics::intersect(sta_hrb_ind_2014, sta_ind_com15a21)

sta_ind_com13a21<-generics::intersect(sta_hrb_ind_2013, sta_ind_com14a21)

sta_ind_com12a21<-generics::intersect(sta_hrb_ind_2012, sta_ind_com13a21)

sta_ind_com11a21<-generics::intersect(sta_hrb_ind_2011, sta_ind_com12a21)

sta_ind_com10a21<-generics::intersect(sta_hrb_ind_2010, sta_ind_com11a21)

```

Il y a 16 stations en commun entre 2010 et 2021. 

```{r}
#création d'un vecteur des 16 stations qui disposent d'un I2M2/métriques entre 2010 et 2021 

sta_hrb_ind<-as.character(sta_ind_com10a21$CODE_STATION)


```


## Evolution de l'I2M2 et ses métriques 

### Représentation graphique 

L'idée est de pouvoir identifier si on observe des grandes tendences de l'I2M2 et ses métriques sur l'ensemble des 19 stations sur la période 2010-2021. Pour chaque indicateur, les distribution sur les 19 stations seront illustrées puis l'évolution à la station sera montré. 


```{r}
Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="Ind Invert Multimetrique" & CODE_STATION %in% c(sta_hrb_ind)) %>% 
  ggplot(aes(x=annee, y=RESULTAT, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("I2M2")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
  
```

Le ligne noire sur le graphique ci-dessus représente la médiane de la distribution pour chaque année.Certains points sont superposés : pour éviter les supperposition, le terme position="jitter" peut être ajouté dans le geom_point, mais en contrepartie le graphique est moins lisible. 


```{r}
Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="IndiceShannonI2M2" & CODE_STATION %in% c(sta_hrb_ind)) %>% 
  ggplot(aes(x=annee, y=RESULTAT, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Indice de Shanon de l'I2M2")+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```

```{r}
Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="AverageScorePerTaxonI2M2" & CODE_STATION %in% c(sta_hrb_ind)) %>% 
  ggplot(aes(x=annee, y=RESULTAT, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("ASPT")+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```

```{r}
Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="PolyvoltinismeI2M2" & CODE_STATION %in% c(sta_hrb_ind)) %>% 
  ggplot(aes(x=annee, y=RESULTAT, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Polyvoltinisme de l'I2M2")+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```


```{r}
Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="OvovivipariteI2M2" & CODE_STATION %in% c(sta_hrb_ind)) %>% 
  ggplot(aes(x=annee, y=RESULTAT, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Ovociparité de l'I2M2")+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```


```{r}
Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="RichesseI2M2" & CODE_STATION %in% c(sta_hrb_ind)) %>% 
  ggplot(aes(x=annee, y=RESULTAT, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Richesse taxonomique de l'I2M2")+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```

```{r}
Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="NbTaxonsI2M2Contributifs" & CODE_STATION %in% c(sta_hrb_ind)) %>% 
  ggplot(aes(x=annee, y=RESULTAT, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Nombre de taxons utilisés pour calculer l'I2M2")+ 
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```

On peut représenter tous ces graphiques sur un même panneau:


```{r}
#ordonnement des niveau du facteur LIB_PAR, pour pouvoir afficher les graphs facette dans l'ordre que'on veut 

Tableau_i2m2_metriques$LIB_PAR<-ordered(Tableau_i2m2_metriques$LIB_PAR, levels=c("Ind Invert Multimetrique",    "AverageScorePerTaxonI2M2","PolyvoltinismeI2M2","OvovivipariteI2M2", "IndiceShannonI2M2","RichesseI2M2","NbTaxonsI2M2Contributifs"))


```


```{r}
Tableau_i2m2_metriques%>% 
  filter(CODE_STATION %in% c(sta_hrb_ind) & LIB_PAR %in% c("IndiceShannonI2M2",
                                                          "AverageScorePerTaxonI2M2",
                                                          "PolyvoltinismeI2M2",
                                                          "OvovivipariteI2M2",
                                                          "RichesseI2M2",
                                                          "Ind Invert Multimetrique")) %>% 
  ggplot(aes(x=annee, y=RESULTAT, group=1, color=secheresse))+
  geom_point(size=0.8)+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Résultat de l'indicateur/métrique")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  facet_wrap(~LIB_PAR)+
  theme(strip.text.x = element_text(size = 8))
```

On peut maintenant regarder à la station si on observe des choses interessantes pour chaque indicateur ou métrique : 

```{r}
Tableau_i2m2_metriques %>% 
  filter(CODE_STATION %in% sta_hrb_ind & LIB_PAR=="Ind Invert Multimetrique") %>% 
  ggplot(aes(x=annee, y=RESULTAT, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("I2M2")+
  facet_wrap(~CODE_STATION)

```


```{r}
Tableau_i2m2_metriques %>% 
  filter(CODE_STATION %in% sta_hrb_ind & LIB_PAR=="AverageScorePerTaxonI2M2") %>% 
  ggplot(aes(x=annee, y=RESULTAT, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("ASPT")+
  facet_wrap(~CODE_STATION)
```


```{r}
Tableau_i2m2_metriques %>% 
  filter(CODE_STATION %in% sta_hrb_ind & LIB_PAR=="PolyvoltinismeI2M2") %>% 
  ggplot(aes(x=annee, y=RESULTAT, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("Polyvoltinisme de l'I2M2")+
  facet_wrap(~CODE_STATION)
```


```{r}
Tableau_i2m2_metriques %>% 
  filter(CODE_STATION %in% sta_hrb_ind & LIB_PAR=="OvovivipariteI2M2") %>% 
  ggplot(aes(x=annee, y=RESULTAT, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("Ovoviparité de l'I2M2")+
  facet_wrap(~CODE_STATION)
```


```{r}
Tableau_i2m2_metriques %>% 
  filter(CODE_STATION %in% sta_hrb_ind & LIB_PAR=="IndiceShannonI2M2") %>% 
  ggplot(aes(x=annee, y=RESULTAT, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("Indice de Shanon de l'I2M2")+
  facet_wrap(~CODE_STATION)
```


```{r}
Tableau_i2m2_metriques %>% 
  filter(CODE_STATION %in% sta_hrb_ind & LIB_PAR=="RichesseI2M2") %>% 
  ggplot(aes(x=annee, y=RESULTAT, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("Richesse taxonomique de l'I2M2")+
  facet_wrap(~CODE_STATION)

```

### Tests statistiques 

Le but des test statistiques et de déterminer si le facteur sécheresse a un effet significatif sur l'I2M2 et ses métriques. 
Comme les sécheresse sont plutôt regroupées ces dernières années, le facteur année pourrait également avoir un effet sur les indicateurs, que l'on pourrait essayer de dissocier du facteur sécheresse. En outre, le facteur station serait aussi susceptible d'influencer les résultats des testes, sans toutefois que l'effet direct de la station sur les indicateurs soient interessants : la station est interessante à intégréer au modèle potentiel car elle peut créer un effet "groupe" dans les indicateurs, mais elle ne nous interesse pas en temps que telle. 

Le but de cette partie est donc de tester le facteur sécheresse, accompagnié ou non selon le modèle, des facteurs année et station. 

Nous pouvons commencer par tester des modèles linéaires mixtes (MLM), qui permettent d'étudier l'effets de facteurs aléatoire ( ici la station), mais qui necessitent la normalité et l'homogénéité des résisus. Si ces hypothèses ne sont pas validées, nous pourrons tester un test de Scheiner-Ray-Hare non paramétrique à deux facteurs, mais qui a le désavantage de n'être que peu robuste. Sinon, il sera toujours possible de réaliser un test de kruskal wallis non paramétrique à un facteur sur la sécheresse et les années séparemment. 

#### MLM 

```{r}
library(lme4)
```

Le modèle à priori que nous allons tester est du type : Indicateur ~Secheresse (fixe) * Annee (fixe) + Station(aléatoire). 

```{r}
# création d'un data frame qui ne contient que les résultat d'i2m2 

df_MLM_i2m2<-Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="Ind Invert Multimetrique")
```


```{r}
#ecriture du MLM 

MLM_i2m2<-lmer(data=df_MLM_i2m2, RESULTAT~secheresse*annee+(1+RESULTAT|CODE_STATION))
```

```{r}
#Vérification des hypothèses de validité
    
    # A. Vérifiez l'homogénéité : graphique des valeurs prédites vs valeurs résiduelles
    E1 <- resid(MLM_i2m2)
    F1 <- fitted(MLM_i2m2)
    plot(x = F1, 
         y = E1, 
         xlab = "Fitted Values",
         ylab = "Normalized residuals")
    abline(h = 0, lty = 2)


```


```{r}
res_MLM_i2m2<-residuals(MLM_i2m2)
shapiro.test(res_MLM_i2m2)       # normalité rejetée 
```
```{r}


```

Les hypothèses de validité de sont pas validées (et ne le seront probablement pas pour les autres indicateurs), donc le test effectué pour l'effet des facteurs sécheresse et année sur les indicateurs sera un test de Sheiner-Ray-Hare. 


#### Test de Sheiner-Ray-Hare 

```{r}
library(rcompanion)
```

##### I2M2 


```{r}
#I2M2 

scheirerRayHare(RESULTAT~secheresse*annee, data=df_MLM_i2m2)
```
Le facteur secheresse n'a pas d'effet significatif, l'interaction annee et secheresse n'est pas significative. Par contre, il semblerait que le facteur annee ait un effet significatif sur l'i2m2. Cela semble étrange au vu des graphique, donc on peut vérifier avec un test de Kruskal wallis uniquement sur les années : 

```{r}
kruskal.test(RESULTAT~annee, data=df_MLM_i2m2)
```
Le test de Kruskal wallis confirme l'effet significatif des années sur l'i2m2. On peut réaliser un test de dunn pour identifier les années ou l'i2m2 est significativement différent des autres : 

```{r}

library(FSA)

dunnTest(RESULTAT~annee, data=df_MLM_i2m2)

```


Le test indique que les années où l'i2m2 est significativement différent sont :

-2010 et 2017 
-2015 et 2017 
-2012 et 2020 
-2016 et 2020 
-2017 et 2020 
-2017 et 2021 

```{r}
# création de groupes avec la fonction kruskal() de agricolae 

comparison<-with(df_MLM_i2m2 ,kruskal(RESULTAT,annee, group=TRUE, p.adj = "bon"))
comparison
```

Les groupes formés par le test de kruskal sont légèrement différents du test de dunn. 
POur une question de praticité (parce que le test kruskal forme directement des groupes, pas uniquement des paires), c'est le test de kruskal avec la méthode d'ajustement de bonferoni qui sera utilisé pour les autres indicateurs. 

###### ASPT 

```{r}
# création data frame ne contenat que l'aspt 

df_ASPT<-Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="AverageScorePerTaxonI2M2")
```

```{r}
# test de sheirer ray hare 

scheirerRayHare(RESULTAT~secheresse*annee, data=df_ASPT)
```
De nouveau, pas d'effet significatif de la secheresse, l'interaction secheresse*annee n'est pas significative, mais l'annee a un effet significatif sur l'aspt. 

```{r}
#formation de groupes pour l'effet de l'année sur l'aspt 

comparison<-with(df_ASPT ,kruskal(RESULTAT,annee, group=TRUE, p.adj = "bon"))
comparison

```
Pas d'effet significatif de l'année pour une formation de groupes avec ce test. Essayons avec le test de dunn. 

```{r}

dunnTest(RESULTAT~annee, data=df_ASPT)
```

Le test de dunn ne montre pas non plus d'effet significatif de l'annee. 

##### Polyvoltinisme 

```{r}

#création du data frame 

df_poly<-Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="PolyvoltinismeI2M2")
```


```{r}
# test de Scheirer-Ray-Hare 

scheirerRayHare(RESULTAT~secheresse*annee, data=df_poly)

```
Pas d'effet significatif de la secheresse, pas d'interaction, mais une drôle de p-value égale à 0 (ou alors le test n'affiche que les premières décimales et ne mets pas en écriture scientifique). Le facteur année aurait un effet significatif sur le polyvoltinisme. 

```{r}
#groupes sur les années avec kruskal

comparison<-with(df_poly ,kruskal(RESULTAT,annee, group=TRUE, p.adj = "bon"))
comparison

```


##### Ovoviparité 

```{r}
# création du data frame d'ovoviparité 

df_ovo<- Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="OvovivipariteI2M2") 
```


```{r}
# test de sheirer

scheirerRayHare(RESULTAT~secheresse*annee, data=df_ovo)

```
Meme constat que pour tous les autres paramètres, pas d'effet de la sécherersse, pas d'intéraction, effet de l'année. 

```{r}
comparison<-with(df_ovo ,kruskal(RESULTAT,annee, group=TRUE, p.adj = "bon"))
comparison
```


##### Richesse 

```{r}
# création du df 

df_rich<-Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="RichesseI2M2")
```


```{r}
#test de scheirer 

scheirerRayHare(RESULTAT~secheresse*annee, data=df_rich)

```

Encore le même constat, pas d'effet de la sécheresse, pas d'interaction, effet de l'année. 

```{r}
comparison<-with(df_rich ,kruskal(RESULTAT,annee, group=TRUE, p.adj = "bon"))
comparison
```
Le test de kruskal ne montre aucune différence significative entre les années. 

##### Indice de Shanon de l'I2M2 

```{r}
#création du df 

df_shanon<- Tableau_i2m2_metriques %>% 
  filter(LIB_PAR=="IndiceShannonI2M2")
```


```{r}
#test de scheirer 

scheirerRayHare(RESULTAT~secheresse*annee, data=df_shanon)

```
Toujours les même conclusions. 

```{r}
comparison<-with(df_shanon ,kruskal(RESULTAT,annee, group=TRUE, p.adj = "bon"))
comparison

```

## NOmbre total d'individus chironomes et ephemères  

Le data frame utilisé sera celui de l'API Hydrobio (extrait de Naïades), même pour le nombre total de taxon par année. En effet, certains taxons de la liste faunistique ne sont pas renseignés dans le SEEE et n'ont donc pas té pris en compte pour les calculs de métriques. 

Avant de pouvoir utilisé le data frame de taxons de l'API, il faut régler le problème de noms de phases qui ne sont pas reneignées de façon standardisée. Le code écrit par Yves-Marie HENO servira à cela.


```{r}
# impotation du fichier excel envoyé à YmH sur grâce auquel il a construit son script 

library(readxl)

taxons_macro_hdf2<-read_excel("raw_data/taxons_macro_hdf.xlsx")

```


```{r}
# Code de YM.Heno 

Phase <- taxons_macro_hdf2[,9]

i <- which(Phase =="1" | Phase =="2" | Phase =="3" | Phase =="4" | Phase =="P1" | Phase =="P2" | Phase =="P3" | Phase =="P4" | Phase =="B1")
Phase[i,1] <- "A"

i <- which(Phase =="5" | Phase =="6" | Phase =="7" | Phase =="8" | Phase =="P5" | Phase =="P6" | Phase =="P7" | Phase =="P8" |
             Phase =="B2" |  Phase =="B4")
Phase[i,1] <- "B"

i <- which(Phase =="9" | Phase =="10" | Phase =="11" | Phase =="12" | Phase =="C'" | Phase =="P9" | Phase =="P10" | Phase =="P11" |
             Phase =="P12"| Phase =="B3")
Phase[i,1] <- "C"
taxons_macro_hdf2[,9] <- Phase
taxons_macro_hdf3 <-  mutate(taxons_macro_hdf,code_op=paste0(code_station_hydrobio,date_prelevement))
n <-nrow(Phase)
Vecteur_vide <- rep("",n)

```

Vérifions que toutes les phases sont sous forme A,B ou C :

```{r}
#transformation du code de phase en facteur 

taxons_macro_hdf2$code_phase<-as.factor(taxons_macro_hdf2$code_phase)

levels(taxons_macro_hdf2$code_phase)
```
```{r}
#création du data frame du nombre d'individus par taxon par année 

taxons_macro_hdf2<-taxons_macro_hdf2 %>% 
  mutate(annee=substr(date_prelevement, 1,4))

taxons_macro_hdf2[taxons_macro_hdf2$annee %in% c("2011", "2017", "2018", "2019", "2020") ,"secheresse"] <- "secheresse" 
taxons_macro_hdf2[taxons_macro_hdf2$annee %in% c("2012", "2021"),  "secheresse"] <- "post_secheresse"
taxons_macro_hdf2[taxons_macro_hdf2$annee %in% c("2010", "2013", "2014", "2015", "2016") ,"secheresse"] <- "pas_secheresse"

nb_indiv_macro<-taxons_macro_hdf2 %>% 
  filter(code_station_hydrobio %in% sta_hrb_tx) %>% 
  dplyr::group_by(annee, secheresse, code_station_hydrobio, libelle_appel_taxon) %>% 
  dplyr::summarise(nb_indiv=sum(resultat_taxon))


```


```{r}

#histogramme du nombre de chironomidae total en fonction des années 

nb_indiv_macro %>% 
  filter(libelle_appel_taxon=="Chironomidae") %>% 
 ggplot(aes(x=annee, y=nb_indiv, fill=secheresse))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Nombre d'individus Chironomidae")+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))

```

```{r}
# création d'un df séparér pour les chironomes 

df_chiro<-nb_indiv_macro %>% 
  filter(libelle_appel_taxon=="Chironomidae")
```

```{r}

# test de scheirer 

scheirerRayHare(nb_indiv~secheresse*annee, data=df_chiro)
```
Rien n'est significatif, même l'année.  

```{r}

comparison<-with(df_chiro ,kruskal(nb_indiv,annee, group=TRUE, p.adj = "bon"))
comparison
```


```{r}

#nb chironomes à la station 

df_chiro %>% 
 ggplot(aes(x=annee, y=nb_indiv, fill=secheresse))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Nombre d'individus Chironomidae")+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text = element_text(size = 6))+
  
  facet_wrap(~code_station_hydrobio)
```


```{r}
#df pour le nb indiv epehemeres 

df_ephe<-nb_indiv_macro %>% 
  filter(libelle_appel_taxon=="Ephemera")
```

```{r}
#boxplot 

df_ephe %>% 
 ggplot(aes(x=annee, y=nb_indiv, fill=secheresse))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Nombre d'individus Ephemera")+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
```
```{r}
scheirerRayHare(nb_indiv~secheresse*annee, data=df_ephe)
```
Aucun effet, même de l'année.  


```{r}
df_ephe %>% 
 ggplot(aes(x=annee, y=nb_indiv, fill=secheresse))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Nombre d'individus Ephemera")+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text = element_text(size = 7))+
  
  facet_wrap(~code_station_hydrobio)
```

## Richesse taxonomique 

La richesse taxonomique (nombre total de taxons) sera calculées à partir de la liste faunistique, étant donnée que certains taxons n'ont pa été intégrés dans le calculs de l'i2m2 et de ses métriques. 

```{r}
# calcul de la richesse taxonomique par année toutes stations confondues 

richess_taxo<-nb_indiv_macro %>% 
  filter(nb_indiv!=0) %>% 
  dplyr::group_by(annee, secheresse, code_station_hydrobio) %>% 
  dplyr::summarise(richesse=n())
  

```


```{r}
richess_taxo %>% 
  ggplot(aes(x=annee, y=richesse, group=1, color=secheresse))+
  geom_point()+
  stat_summary(fun.y = "median", geom = "line", color = "black", size = 1.2)+
  theme(axis.text.x = element_text(angle = 90))+ 
  ylab("Richesse taxonomique")+
  scale_color_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))
  
```


```{r}
# test de sheirer 

scheirerRayHare(richesse~secheresse*annee, data=richess_taxo)

```

Rien n'est significatif. 


```{r}
#représentaton par années 

richess_taxo %>% 
 ggplot(aes(x=annee, y=richesse, fill=secheresse))+
  geom_col()+
  scale_fill_manual(values = c("secheresse" = '#e6194b',  "pas_secheresse"='#3cb44b',
                                'post_secheresse' = '#ffe119'))+
  theme(axis.text.x = element_text(angle = 90))+
  theme(axis.text = element_text(size = 7))+
  ylab("Richesse taxonomique")+
  facet_wrap(~code_station_hydrobio)

```

